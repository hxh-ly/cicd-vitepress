## 1.React çš„æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯ä»€ä¹ˆï¼Ÿåˆ—ä¸¾å…¶ä¸‰å¤§æ ¸å¿ƒç‰¹æ€§ï¼Ÿ

æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯å£°æ˜å¼ã€ç»„ä»¶åŒ–ã€å’Œå•å‘æ•°æ®æµå±•å¼€ï¼Œè¿™ä½¿å¾— React åœ¨æ„å»ºå¤æ‚çš„ç”¨æˆ·ç•Œé¢æ—¶æ›´åŠ é«˜æ•ˆã€å¯ç»´æŠ¤ã€‚å…¶ä¸‰å¤§æ ¸å¿ƒç‰¹æ€§ - è™šæ‹Ÿ DOMã€ ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€ hooks

- è™šæ‹Ÿ DOM æä¾›æ€§èƒ½ä¼˜åŒ–ï¼Œå‡å°‘ä¸å¿…è¦çš„ DOM æ“ä½œã€‚
- ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç† è®©å¼€å‘è€…å¯ä»¥åœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹æ‰§è¡Œæ“ä½œã€‚
- hooks ä½¿å¾—å‡½æ•°å¼ç»„ä»¶èƒ½å¤Ÿç®¡ç†çŠ¶æ€å’Œå‰¯ä½œç”¨ï¼Œç®€åŒ–å¼€å‘æµç¨‹ã€‚

## 2.è§£é‡Šè™šæ‹Ÿ DOM çš„å·¥ä½œåŸç†ä»¥åŠå…¶æ€§èƒ½ä¼˜åŒ–çš„æœºåˆ¶ï¼Ÿ
ç­” 1.
åŸç†ï¼šå°† jsx ç¼–è¯‘ä¸ºä¸€ä¸ª render å‡½æ•°ï¼Œæ‰§è¡Œ render å‡½æ•°ä¼šç”Ÿæˆä¸€ä¸ª React Element çš„ js å¯¹è±¡ï¼ˆä¹Ÿç§°ä¸ºè™šæ‹Ÿ domï¼‰
æ€§èƒ½ä¼˜åŒ–çš„æœºåˆ¶ï¼šåœ¨çŠ¶æ€å‘ç”Ÿæ›´æ–°çš„æ—¶å€™ï¼Œä¼šæ ¹æ®å‰å vdom è¿›è¡Œå¯¹æ¯”ï¼Œæ ‡è®°å¢åˆ æ”¹çš„ç»„ä»¶çŠ¶æ€ï¼Œè§£æå®Œæ•´æ£µæ ‘ååœ¨å¯¹åº”çœŸå® DOM çš„å¢åˆ æ”¹æ›´æ–°ã€‚
ç­” 2.
è™šæ‹Ÿ DOM çš„æ¦‚å¿µï¼šè™šæ‹Ÿ DOM æ˜¯ä¸€ç§åœ¨å†…å­˜è¡¨ç¤ºçœŸå® DOM çš„è½»é‡çº§å‰¯æœ¬çš„æŠ€æœ¯ã€‚å®ƒæ˜¯ä¸€ä¸ª javascript å¯¹è±¡ï¼Œæ¨¡æ‹Ÿäº†æµè§ˆå™¨çš„ DOM ç»“æ„ã€‚
å·¥ä½œåŸç†ï¼šåˆæ¬¡æ¸²æŸ“ï¼šå½“ React åº”ç”¨é¦–æ¬¡åŠ è½½ï¼Œå®ƒä¼šæ„å»ºä¸€ä¸ªè™šæ‹Ÿ DOMï¼Œæ˜¯ React å…ƒç´ çš„ javascript å¯¹è±¡è¡¨ç¤ºã€‚è¿™ä¸ªè™šæ‹Ÿ DOM æ ‘åŒ…å«äº†æ‰€æœ‰çš„ UI ç»„ä»¶ä»¥åŠå®ƒä»¬çš„çŠ¶æ€ï¼›æ›´æ–°ç»„ä»¶çŠ¶æ€ï¼šå½“ç»„ä»¶çš„ state æˆ–è€… props å‘ç”Ÿå˜åŒ–ï¼ŒReact ä¼šé‡æ–°æ¸²æŸ“è¯¥ç»„ä»¶ã€‚æ­¤æ—¶ React ä¼šæ„å»ºæ–°çš„è™šæ‹Ÿ DOM æ ‘ï¼Œå¹¶ä¸ä¸Šä¸€æ¬¡æ¸²æŸ“çš„è™šæ‹Ÿ DOM æ ‘è¿›è¡Œå¯¹æ¯”ã€‚æ‰¹é‡æ›´æ–°ï¼šä¸€æ—¦ç¡®è®¤æŸéƒ¨åˆ†éœ€è¦æ›´æ–°ï¼ŒReact ä¼šå°†è¿™äº›æ›´æ–°æ‰¹é‡æäº¤ç»™çœŸå® DOMã€‚
æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼š
Diff ç®—æ³•æ˜¯ React æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒã€‚

- åŸºäºç»„ä»¶å±‚çº§çš„æ¯”è¾ƒï¼šå®ƒå‡å®šåŒä¸€å±‚çº§çš„å…ƒç´ å¤§æ¦‚ç‡ä¸å˜ï¼Œå› æ­¤ React å¯ä»¥è·³è¿‡å¯¹å…ƒç´ ç±»å‹çš„æ·±åº¦æ¯”è¾ƒï¼Œä¼˜å…ˆå¯¹èŠ‚ç‚¹çš„å…³é”®å±æ€§è¿›è¡Œæ¯”è¾ƒã€‚
- æœ€å°åŒ–æ¯”è¾ƒèŒƒå›´ï¼šReact ä¸ä¼šå¯¹æ•´ä½“è™šæ‹Ÿ Dom æ ‘è¿›è¡Œå®Œå…¨å¯¹æ¯”ï¼Œè€Œæ˜¯åªæ¯”è¾ƒæœ€è¿‘å‘ç”Ÿæ”¹å˜çš„éƒ¨åˆ†ã€‚
- å‡è®¾åŒç±»å…ƒç´ ç›¸åŒï¼šReact å‡è®¾åŒä¸€ç±»å‹çš„ DOM å…ƒç´ åœ¨æ›´æ–°æ—¶ä¸å‘ç”Ÿé‡å¤§ç»“æ„å˜åŒ–ï¼Œå› æ­¤å®ƒä¼šé‡ç”¨ä¹‹å‰çš„ Dom èŠ‚ç‚¹ã€‚è¿™ç§ä¼˜åŒ–ç­–ç•¥å«åšâ€œå…ƒç´ ç±»å‹çš„é‡ç”¨â€ï¼Œå®ƒé¿å…äº†ä¸å¿…è¦çš„ Dom å…ƒç´ é‡å»ºã€‚
  æœ€å°åŒ–çœŸå® DOM çš„æ“ä½œ
- æ‰¹é‡æ›´æ–°ï¼šReact ä¼šå°†å¤šæ¬¡éœ€è¦æ›´æ–° DOM çš„æ“ä½œåˆå¹¶æˆä¸€ä¸ªæ‰¹é‡æ›´æ–°çš„è¿‡ç¨‹ï¼Œå‡å°‘äº†æ¯æ¬¡æ›´æ–°çš„å¼€é”€ã€‚
- é€‰æ‹©æ€§æ›´æ–°ï¼šåªæ›´æ–°å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ† DOM å…ƒç´ ã€‚
- å±€éƒ¨æ›´æ–°ï¼šåˆ©ç”¨è™šæ‹Ÿ DOM çš„ diffï¼Œåªæ›´æ–°å®é™…å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†ï¼Œè€Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªé¡µé¢æˆ–ç»„ä»¶ã€‚
  reconcilation çš„è¿‡ç¨‹
  reconcilation æ˜¯æŒ‡ React å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªè™šæ‹Ÿ DOM æ ‘å¹¶å†³å®šå¦‚ä½•å°†å®ƒä»¬æ›´æ–°åˆ°çœŸå® DOM ä¸­ã€‚Reconciliation ä¹ŸåŒ…å«æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼š
- ç»„ä»¶ key å±æ€§ï¼šç”¨äºå¸®åŠ©è¯†åˆ«é‚£äº›å…ƒç´ è¢«æ›´æ”¹ã€æ·»åŠ æˆ–è€…åˆ é™¤ã€‚
- å…ƒç´ ç±»å‹æ¯”è¾ƒï¼šReact å‡è®¾å¦‚æœä¸¤ä¸ªç›¸åŒå±‚çº§çš„ DOM å…ƒç´ ç±»å‹å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå®ƒä»¬çš„ç»“æ„å¾ˆå¯èƒ½ä¼šä¸åŒï¼Œå› æ­¤å®ƒä¼šé€‰æ‹©é‡æ–°åˆ›å»ºæ•´ä¸ª DOM å…ƒç´ ã€‚

é€šè¿‡ä¸€äº›ç­–ç•¥ä¼˜åŒ–æ€§èƒ½ï¼š

- shouldComponentUpdate è¿”å› true æ‰é‡æ–°æ¸²æŸ“è¯¥ç»„ä»¶
- React.memoã€‚å¯¹äºå‡½æ•°ç»„ä»¶ï¼Œå¦‚æœ props ä¸å˜åŒ–ï¼Œåˆ™è·³è¿‡æ¸²æŸ“è¿‡ç¨‹ï¼Œç›´æ¥å¤ç”¨ä¹‹å‰çš„ç»“æœã€‚
- æ‡’åŠ è½½å’Œä»£ç åˆ†å‰²ã€‚react é€šè¿‡ React.lazy å’Œ Suspense å®ç°ç»„ä»¶æ‡’åŠ è½½ã€‚

## é™„åŠ ï¼šSuspense æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

```tsx
// ä½¿ç”¨
function Comp() {
  return <>delay</>;
}
const Lazy = React.lazy(() => delay(5000).then((x) => ({ default: Comp })));
function App() {
  return (
    <>
      <Suspense fallback={'loading'}>
        <Lazy></Lazy>
      </Suspense>
    </>
  );
}
```
Suspenseåªæ˜¯æä¾›äº†ç”¨äºåŠ è½½æ•°æ®çš„æ ‡å‡†ï¼Œ`åŠ è½½`->`è¿‡æ¸¡`->`å®Œæˆåˆ‡æ¢`
æ­¥éª¤ï¼š
1.éå†åˆ°primiayç»„ä»¶ï¼ŒæŠ›å‡ºå¼‚å¸¸
2.æ•è·ï¼Œæ·»åŠ å›è°ƒ
3.å±•ç¤ºfallback
4.åŠ è½½å®Œæˆï¼Œæ‰§è¡Œå›è°ƒ
5.å±•ç¤ºåŠ è½½å®Œæˆåçš„ç»„ä»¶

## é™„åŠ ï¼šReact æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µ
React.memo

```tsx
// React.memoçš„ä½¿ç”¨

// 1.çº¯å±•ç¤ºç»„ä»¶
function Test1({data}:props){}
return default React.memo(Test1)
// 2.æ¸²æŸ“å¼€é”€å¾ˆå¤§çš„ç»„ä»¶
function Chat = React.memo(({data})=>{
    const chartData = processData(data) // æ˜‚è´µçš„æ¸²æŸ“è®¡ç®—
    return  <svg width="600" height="400">
      {/* å¤æ‚SVGæ¸²æŸ“ */}
    </svg>
})
// 3.é¢‘ç¹é‡æ–°æ¸²æŸ“çš„åˆ—è¡¨é¡¹
const ListItem = React.memo(({ item, onSelect }) => (
  <li onClick={() => onSelect(item.id)}>
    {item.name} - {item.price}
  </li>
));
// 4.ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°
const ComplexComponent = React.memo(({config})=>{},(prevProps,nextProps)=>{
    return _.isEqual(prevProps.config, nextProps.config);
})
// 5.ç»„åˆ useMemoå’ŒuseCallback
const Test5 = ({data,callback})=>{
    return <></>
}
function App(){
  const items = [{},{}]
// ä½¿ç”¨useCallbackç¨³å®šå‡½æ•°å¼•ç”¨
  const handleClick = useCallback(() => {
    console.log('ç‚¹å‡»');
  }, []);
  // ä½¿ç”¨useMemoç¨³å®šå¯¹è±¡å¼•ç”¨
  const userData = useMemo(() => ({
    name: 'John',
    age: 30
  }), []);

    return <>

    <Test1 data='é™æ€æ•°æ®'></Test1>
    <Chat></Chat>
    {
        items.map(v=>(<ListItem/>))
    }
    <ComplexComponent></ComplexComponent>
    <Test5 data={userData} callback={handleClick}></Test5>
    </>
}
```

## 3.jsx çš„æœ¬è´¨ä¸Šä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæµè§ˆå™¨æ— æ³•ç›´æ¥è§£æ jsxï¼Ÿ
æœ¬è´¨æ˜¯ï¼š
1.js çš„è¯­æ³•æ‰©å±• 2.æ˜¯ React.createElement()çš„è°ƒç”¨ç®€å†™ 3.ä¸€ä¸ªå£°æ˜å¼çš„ UI æè¿°è¯­æ³•
ä¸ºä»€ä¹ˆæ— æ³•ç›´æ¥è§£æ jsxï¼Ÿå› ä¸ºæ˜¯ js æ‰©å±•è¯­æ³•ï¼Œæµè§ˆå™¨åªç†è§£çº¯ javascript

## 4.React ä¸ Angular/Vue çš„æ ¸å¿ƒåŒºåˆ«ï¼ˆå¦‚æ•°æ®ç»‘å®šï¼ŒDOM æ“ä½œã€æ¶æ„è®¾è®¡ï¼‰
| åŒºåˆ« | React | Angular | Vue |
| ---- | ---- | ---- | ---- |
| æ•°æ®ç»‘å®š | å•å‘æ•°æ®æµ | é»˜è®¤åŒå‘æ•°æ®ç»‘å®š | åŒå‘ç»‘å®š+å•å‘æ”¯æŒ |
| DOM æ“ä½œ | åŸºäº vdom | çœŸå® Dom | åŸºäº vdom |
| æ¶æ„è®¾è®¡ | ä»…å…³æ³¨ viewï¼Œå…¶ä»–ä¾èµ–ç¤¾åŒºç”Ÿæ€ | å…¨å®¶æ¡¶ | æä¾›æ¸è¿›å¼æ¡†æ¶ |
| æ¨¡ç‰ˆè¯­æ³• | JSX | æ¨¡ç‰ˆè¯­æ³•+è£…é¥°å™¨ | æ¨¡ç‰ˆè¯­æ³•+å¯é€‰ JSX |

## 5.è§£é‡Š React çš„â€œå•å‘æ•°æ®æµâ€ç‰¹æ€§ä»¥å…¶å®è·µæ„ä¹‰
ç‰¹æ€§ï¼šæ•°æ®æµæ˜¯å•å‘ï¼Œä»çˆ¶ç»„ä»¶ä¼ é€’åˆ°å­ç»„ä»¶ï¼Œå­ç»„ä»¶æ— æ³•ç›´æ¥ä¿®æ”¹çˆ¶ç»„ä»¶çš„çŠ¶æ€ï¼Œè€Œæ˜¯é€šè¿‡å›è°ƒå‡½æ•°å‘ä¸Šä¼ é€’æ„å›¾ã€‚
æ„ä¹‰ï¼šå¯é¢„æµ‹æ€§æ›´å¼ºï¼šçŠ¶æ€çš„æ¥æºæ˜ç¡®ï¼Œç»„ä»¶è¡Œä¸ºè·Ÿå®¹æ˜“è¿½è¸ªå’Œæµ‹è¯•ã€‚è°ƒè¯•æ›´æ–¹ä¾¿ï¼šå¯ç”¨ React DevTools ç­‰å·¥å…·æŸ¥çœ‹æ•°æ®æµå‘ã€‚æ›´å®¹æ˜“æ„å»ºå¤§å‹åº”ç”¨ï¼šçŠ¶æ€æå‡ã€çŠ¶æ€ç®¡ç†ï¼ˆReduxã€Zustand ï¼‰

## 6.ä»€ä¹ˆæ˜¯åˆæˆäº‹ä»¶ï¼Ÿä¸åŸç”Ÿäº‹ä»¶æœ‰ä½•åŒºåˆ«ï¼Ÿ
åˆæˆæ˜¯äº‹ä»¶æ˜¯Reactå°è£…çš„ä¸€ç§äº‹ä»¶ï¼Œå®ƒæ¨¡æ‹Ÿäº†æµè§ˆå™¨çš„åŸç”Ÿäº‹ä»¶å¯¹è±¡ï¼Œä½†åˆæä¾›äº†ä¸€äº›é¢å¤–çš„ä¼˜åŠ¿ã€‚Reactä½¿ç”¨åˆæˆäº‹ä»¶ç³»ç»Ÿæ¥å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼ˆç‚¹å‡»ã€é¼ æ ‡äº‹ä»¶ã€é”®ç›˜äº‹ä»¶ï¼‰ï¼Œç›®çš„æ˜¯åœ¨ä¸åŒæµè§ˆå™¨ä¸­ç»Ÿä¸€å¤„ç†äº‹ä»¶ï¼Œä¼˜åŒ–æ€§èƒ½å¹¶é¿å…å†…å­˜æ³„æ¼ã€‚
ç‰¹ç‚¹ï¼š
- è·¨æµè§ˆå™¨ä¸€è‡´æ€§ï¼šä¸åŒæµè§ˆå™¨å¯¹äº‹ä»¶çš„å®ç°å’Œå¤„ç†æ–¹å¼å„ä¸ç›¸åŒï¼ŒReactå°è£…äº†è¿™äº›å·®å¼‚ï¼Œä½¿å¾—åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­äº‹ä»¶çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ã€‚é€šè¿‡åˆæˆäº‹ä»¶ï¼ŒReacté¿å…äº†æµè§ˆå™¨å·®å¼‚å¼•èµ·çš„é—®é¢˜ã€‚
ä¸¾ä¾‹å„ä¸ªæµè§ˆå™¨äº‹ä»¶çš„å·®å¼‚
| åŠŸèƒ½ç‚¹ | IE/edge | Chrome | Safari |
| ---- | ---- | ---- | ---- |
| äº‹ä»¶å¯¹è±¡è·å– | window.event | å›è°ƒå‚æ•°e | å›è°ƒå‚æ•°e |
| é˜»æ­¢é»˜è®¤äº‹ä»¶ | e.returnValue = false | e.preventDefault() | e.preventDefault() |
| é˜»æ­¢å†’æ³¡ | e.cancelBubble = true | e.stopProppagation() | e.stopProppagation() |
| é¼ æ ‡æ»šè½®äº‹ä»¶ | onmousewheel | onwheel | onmousewheel |
| é”®ç›˜äº‹ä»¶ç¼–ç  | e.keyCode | e.key | e.keyCode |
- äº‹ä»¶æ± åŒ–ï¼šReactåœ¨åˆæˆäº‹ä»¶å¯¹è±¡çš„å®ç°ä¸­é‡‡ç”¨äº†äº‹ä»¶æ± åŒ–çš„ç­–ç•¥ã€‚è¿™æ„å‘³å½“äº‹ä»¶å¤„ç†å®Œæˆåï¼ŒReactä¼šå°†äº‹ä»¶å¯¹è±¡é‡æ–°æ”¾å…¥æ± ä¸­ï¼Œè€Œä¸æ˜¯ä¿ç•™æ¯ä¸ªäº‹ä»¶çš„å®ä¾‹ï¼Œä»è€Œå‡å°‘å†…å­˜çš„å¼€é”€ã€‚äº‹ä»¶æ± åŒ–çš„å®ç°æ„å‘³ç€äº‹ä»¶å¯¹è±¡çš„å±æ€§å€¼åªèƒ½åœ¨äº‹ä»¶å›è°ƒå‡½æ•°ä¸­è®¿é—®ï¼Œè€Œåœ¨å›è°ƒæ‰§è¡Œåï¼Œå±æ€§ä¼šè¢«æ¸…ç©ºã€‚
1.å†…å­˜ä¼˜åŒ–
| äº‹ä»¶ç±»å‹ | æ— æ± åŒ–ï¼ˆå¯¹è±¡æ•°ï¼‰ | æœ‰æ± åŒ–ï¼ˆå¯¹è±¡æ•°ï¼‰ | å†…å­˜èŠ‚çœ |
| ---- | ---- | ---- | ---- |
| ç‚¹å‡»äº‹ä»¶ | 1000 | 10 | 99% |
| é¼ æ ‡ç§»åŠ¨ | 10000| 20 | 99.8% |
| æ»šåŠ¨äº‹ä»¶ | 5000 | 15 | 98.7% |
2.åƒåœ¾å›æ”¶ä¼˜åŒ–
åˆ›å»ºå¤§é‡çŸ­æœŸå¯¹è±¡ä¼šå¢åŠ åƒåœ¾å›æ”¶é¢‘ç‡ï¼›åƒåœ¾å›æ”¶ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œé€ æˆé¡µé¢å¡é¡¿ï¼ˆç§°GCå¡é¡¿ï¼‰
3.é«˜é¢‘äº‹ä»¶æ€§èƒ½ä¼˜åŒ–

- ç»Ÿä¸€çš„æ¥å£ï¼šåˆæˆäº‹ä»¶å°è£…äº†æ ‡å‡†çš„åŸç”Ÿäº‹ä»¶æ¥å£ï¼Œå¹¶æä¾›ä¸€è‡´çš„APIæ¥è®¿é—®äº‹ä»¶çš„å±æ€§ï¼Œå¦‚`event.target` `event.preventDefault` `event.stopPropagation`
- äº‹ä»¶ä»£ç†ï¼šåŸç”Ÿäº‹ä»¶ä¼šåœ¨æ¯ä¸ªdomæ·»åŠ äº‹ä»¶ç›‘å¬å™¨ã€‚åˆæˆäº‹ä»¶ï¼ŒReactä¼šåœ¨`document`æ·»åŠ ä¸€ä¸ªå…¨å±€äº‹ä»¶ç›‘å¬å™¨ï¼Œå½“ä»»ä½•å­å…ƒç´ è§¦å‘çš„æ—¶å€™ï¼Œè¿™ä¸ªå…¨å±€ç›‘å¬å™¨ä¼šæ•è·åˆ°äº‹ä»¶å¹¶å°†å…¶åˆ†å‘ç»™ç›®æ ‡å…ƒç´ ï¼Œè¿™ç§æ–¹æ³•å‡å°‘äº†äº‹ä»¶ç›‘å¬å™¨çš„æ•°é‡ï¼Œé¿å…äº†æ¯ä¸ªDOMå…ƒç´ éƒ½ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼Œä»è€Œä¼˜åŒ–æ€§èƒ½ã€‚

## 7.Reactç»„ä»¶åŒ–çš„æ€æƒ³å¦‚ä½•æå‡ä»£ç å¤ç”¨ç‡ï¼Ÿ
- æ¨¡å—åŒ–ï¼Œé¡µé¢æ‹†åˆ†ä¸ºå„ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œç»„ä»¶ä½œä¸ºç‹¬ç«‹çš„å•å…ƒå¯ä»¥åœ¨ä¸åŒåœ°æ–¹å¤ç”¨ï¼Œé¿å…é‡å¤ä»£ç ã€‚
- å¯é…ç½®åŒ–ã€‚ä¼ å…¥ä¸åŒpropsåœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨
- ç»„åˆåŒ–ã€‚é€šè¿‡ç»„ä»¶åµŒå¥—å’Œç»„åˆï¼Œæ„å»ºå¤æ‚UI
- é€»è¾‘å¤ç”¨ã€‚è‡ªå®šä¹‰hookså’Œhocå’Œrender propsï¼Œå¯ä»¥å¤ç”¨é€»è¾‘è€Œä¸å½±å“ç»„ä»¶åŠŸèƒ½ã€‚
- æå‡çŠ¶æ€ã€‚é€šè¿‡å°†å…±äº«çŠ¶æ€æå‡åˆ°å…±åŒçš„ç»„ä»¶ï¼Œé¿å…äº†çŠ¶æ€é‡å¤ç®¡ç†å’ŒåŒæ­¥é—®é¢˜ã€‚
è¿™äº›è®¾è®¡ç†å¿µå’Œæ¨¡å¼è®©Reactçš„ç»„ä»¶åŒ–ä¸ä»…ä»…æ˜¯ä»£ç çš„å¤ç”¨ï¼Œæ›´æ˜¯é€šè¿‡ç»“æ„åŒ–çš„æ–¹å¼ä½¿å¾—UIå’Œå’Œé€»è¾‘çš„ç®¡ç†å˜å¾—æ›´åŠ é«˜æ•ˆå’Œå¯ç»´æŠ¤ã€‚

## 8.è§£é‡ŠReactçš„â€œç»„ä»¶å³å‡½æ•°â€ç†å¿µï¼ˆå‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶çš„æœ¬è´¨åŒºåˆ«ï¼‰
ç†å¿µï¼š
1.Reactç»„ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ¥å—è¾“å…¥ï¼ˆpropsï¼‰å¹¶è¿”å›è¾“å‡ºï¼ˆUIæè¿°ï¼‰çš„å‡½æ•°ã€‚
2.ç»„ä»¶çš„æ ¸å¿ƒèŒè´£æ˜¯ï¼šprops -> UI
3.ç»„ä»¶åº”è¯¥æ˜¯çº¯å‡€çš„ï¼šç›¸åŒè¾“å…¥æ€»æ˜¯äº§ç”Ÿç›¸åŒè¾“å‡º
4.ç»„ä»¶åº”è¯¥æ˜¯å¯ç»„åˆçš„ï¼šåƒå‡½æ•°ä¸€æ ·å¯ä»¥åµŒå¥—ç»„åˆ
æœ¬è´¨åŒºåˆ«ï¼š
1.è¯­æ³•å’Œç»“æ„
- å‡½æ•°ç»„ä»¶ï¼šä¸€ä¸ªæ™®é€šçš„javascriptå‡½æ•°ï¼Œæ¥å—propsä½œä¸ºå‚æ•°å¹¶è¿”å›jsxã€‚æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€this
- ç±»ç»„ä»¶ï¼šåŸºäºES6ç±»å®šä¹‰ï¼Œç»§æ‰¿è‡ªReact.Component,éœ€è¦æ‰‹åŠ¨å®ç°renderæ–¹æ³•ï¼Œå¹¶ä½¿ç”¨this.stateå’Œthis.setStateç®¡ç†çŠ¶æ€ã€‚
2.ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š
- ç±»ç»„ä»¶ï¼šç±»ç»„ä»¶æœ‰å†…å»ºçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå¯ä»¥åœ¨è¿™äº›æ–¹æ³•ä¸­æ‰§è¡Œå¼‚æ­¥æ“ä½œã€æ›´æ–°çŠ¶æ€ç­‰ã€‚ä¾‹å¦‚ `componentDidMount` `componentWillUnmount`
- å‡½æ•°ç»„ä»¶ï¼šå‡½æ•°ç»„ä»¶æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä½†é€šè¿‡React Hooksï¼ˆå¦‚useEffectï¼‰å¼•å…¥å‡½æ•°ç»„ä»¶çš„å‰¯ä½œç”¨å¤„ç†ï¼Œä½¿å‡½æ•°ç»„ä»¶å…·å¤‡ç±»ä¼¼ç±»ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†åŠŸèƒ½ã€‚useEffectå…è®¸æˆ‘ä»¬åœ¨ç»„ä»¶æŒ‚è½½ã€æ›´æ–°å’Œå¸è½½æ—¶æ‰§è¡Œå‰¯ä½œç”¨ã€‚
3.çŠ¶æ€ç®¡ç†
- ç±»ç»„ä»¶ï¼šä½¿ç”¨this.stateæ¥ç®¡ç†çŠ¶æ€ï¼Œä½¿ç”¨this.setStateæ¥æ›´æ–°çŠ¶æ€ã€‚setStateæ˜¯å¼‚æ­¥çš„ï¼Œå¹¶ä¸”ä¼šè§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚
- å‡½æ•°ç»„ä»¶ï¼šå‡½æ•°ç»„ä»¶åŸæœ¬æ˜¯æ— çŠ¶æ€çš„ï¼Œä½†éšç€React Hooksçš„å¼•å…¥ï¼ŒuseStateä½¿å¾—å‡½æ•°ç»„ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨çŠ¶æ€ç®¡ç†ã€‚
æ€»ç»“ï¼šReactçš„â€œç»„ä»¶å³å‡½æ•°â€ç†å¿µï¼Œæ„å‘³ç€Reactç»„ä»¶å¯ä»¥ç®€å•åœ°ç”¨å‡½æ•°å®ç°ï¼Œè€Œæ— éœ€ä¾èµ–å¤æ‚çš„ç±»ç»§æ‰¿ç»“æ„ã€‚å‡½æ•°ç»„ä»¶é€šè¿‡å…¶ç®€æ´çš„ç»“æ„ã€æ˜“äºç†è§£çš„APIå’Œæ€§èƒ½ä¼˜åŠ¿å—ï¼Œæˆä¸ºç°ä»£Reactå¼€å‘çš„é¦–é€‰æ–¹å¼ã€‚

## 9.Reactçš„ä¸¥æ ¼æ¨¡å¼ï¼ˆStrict Modeï¼‰è§£å†³äº†å“ªäº›æ½œåœ¨é—®é¢˜ï¼Ÿ
1. è¿‡æ—¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼š16.3å`ComponentWillMount` `ComponentWillReceiveProps` `ComponentWillUpdate`ä¸åœ¨æ¨èä½¿ç”¨
2. æ„å¤–çš„å‰¯ä½œç”¨ï¼šä¸¥æ ¼æ¨¡å¼ä¼šå¼€å¯åŒé‡æ¸²æŸ“ï¼Œè¿™æ„å‘³ç€ç»„ä»¶çš„æ¸²æŸ“å’Œå‰¯ä½œç”¨å‡½æ•°ä¼šè¢«æ‰§è¡Œ2æ¬¡ï¼ŒReactä¼šä¸»åŠ¨è§¦å‘ä¸¤æ¬¡æ¸²æŸ“æ¥ç¡®ä¿å‰¯ä½œç”¨å‡½æ•°æ˜¯çº¯ç²¹çš„ï¼Œä¸ä¼šå½±å“åç»­çš„æ¸²æŸ“è¿‡ç¨‹ã€‚
3. ä¸å®‰å…¨çš„findDOMNodeã€‚è¿™ä¸ªæ–¹æ³•å·²ç»è¿‡æ—¶ï¼Œæ¨èä½¿ç”¨Refæ¥è®¿é—®å…ƒç´ ã€‚
4. ä¸æ¨èå­—ç¬¦ä¸²refs
5. ä¸ç¨³å®šçš„å‰¯ä½œç”¨ï¼ˆsetStateï¼‰ åœ¨componenWillUnmountä¸èƒ½ä½¿ç”¨setState
6. å¼‚æ­¥æ¸²æŸ“çš„ç›¸å…³é—®é¢˜ï¼šreact16ä¹‹åå¼•å…¥å¼‚æ­¥æ¸²æŸ“ï¼ˆconcurent renderingï¼‰ä¸¥æ ¼æ¨¡å¼å¯ä»¥å¸®åŠ©å¼€å‘è€…æå‰å‘ç°ä¸€äº›ä¸å¼‚æ­¥æ¸²æŸ“ç›¸å…³çš„bug
7. ä¸ç¨³å®šçš„ä¸Šä¸‹æ–‡
æ€»ç»“ï¼š
Reactçš„ä¸¥æ ¼æ¨¡å¼æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒå¸®åŠ©å¼€å‘è€…æ£€æµ‹å¹¶è§£å†³æ½œåœ¨çš„é”™è¯¯å’Œæ€§èƒ½é—®é¢˜ã€‚ä¸¥æ ¼æ¨¡å¼é€šè¿‡å¯¹ç»„ä»¶çš„åŒé‡æ¸²æŸ“ã€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„æ£€æŸ¥ã€ä¸æ¨èçš„APIä½¿ç”¨è­¦å‘Šç­‰æ–¹å¼ï¼Œç¡®ä¿å¼€å‘è€…ç¼–å†™çš„ä»£ç ç¬¦åˆReactçš„æœ€ä½³å®è·µã€‚

## 10.Reactçš„æœ€æ–°ç‰ˆæœ¬ç‰¹æ€§ï¼ˆReact18ï¼‰
å¹¶å‘æ¨¡å¼
- æ¸²æŸ“è¿‡ç¨‹å¯ä¸­æ–­ï¼ŒReactå¯åœ¨åˆé€‚æ—¶æœºè°ƒåº¦ä»»åŠ¡ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
- æ¯”å¦‚ï¼šè¾“å…¥æ¡†ä¸ä¼šå› å¤§å‹æ¸²æŸ“ä»»åŠ¡è€Œå¡é¡¿
è‡ªåŠ¨æ‰¹å¤„ç†
```tsx
setCount(a+1)
setName('aa')
```
useTransition
æ ‡è®°éç´§æ€¥æ›´æ–°
æ–°Root Apiå’ŒSSRæ”¹è¿›
æ”¯æŒcreateRootæ›¿ä»£æ—§ç‰ˆReactDOM.render
SSRæ”¯æŒå»¶è¿ŸåŠ è½½ç‰‡æ®µã€æµå¼ä¼ è¾“ï¼ˆStreamingï¼‰

## 11.è°ƒç”¨setStateåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿè§£é‡Šå…¶å¼‚æ­¥æ‰¹å¤„ç†æœºåˆ¶ 
åŸºæœ¬æµç¨‹ï¼š
1. å…¥é˜Ÿ-> å°†æ›´æ–°åŠ å…¥é˜Ÿåˆ—
2. æ‰¹å¤„ç†-> åˆå¹¶å¤šä¸ªæ›´æ–°è¯·æ±‚
3. åˆå¹¶-> è®¡ç®—æœ€ç»ˆçŠ¶æ€å€¼
4. åè°ƒ-> Fiberæ ‘Diffè®¡ç®—
5. æäº¤-> åŸå­åŒ–DOMæ›´æ–°
`Reactçš„æ‰¹å¤„ç†ä¸æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œè€Œæ˜¯ä¿è¯UIä¸€è‡´æ€§çš„å¿…è¦æœºåˆ¶ã€‚å®ƒç¡®ä¿æ— è®ºä½ è°ƒç”¨å¤šå°‘æ¬¡setStateï¼Œæœ€ç»ˆç”¨æˆ·åªä¼šçœ‹åˆ°ä¸€æ¬¡å®Œæ•´çš„UIæ›´æ–°`

æºç å¯¼è¯»ï¼š

1.æ›´æ–°å…¥é˜Ÿé˜¶æ®µ
```js
// setState å…¥å£
enqueueSetState(inst, payload, callback) {
  const fiber = getInstance(inst);
  const eventTime = requestEventTime();
  const lane = requestUpdateLane(fiber); // è·å–æ›´æ–°ä¼˜å…ˆçº§
  
  // åˆ›å»ºæ›´æ–°å¯¹è±¡
  const update = createUpdate(eventTime, lane);
  update.payload = payload;
  
  // åŠ å…¥æ›´æ–°é˜Ÿåˆ—
  enqueueUpdate(fiber, update);
  
  // è°ƒåº¦æ›´æ–°
  scheduleUpdateOnFiber(fiber, lane, eventTime);
}
```
æ ¸å¿ƒæ“ä½œ:

- åˆ›å»º update å¯¹è±¡ï¼ˆåŒ…å« payload å’Œå›è°ƒï¼‰

- å°† update åŠ å…¥ fiber èŠ‚ç‚¹çš„æ›´æ–°é˜Ÿåˆ—

- æ ‡è®° fiber ä¸ºéœ€è¦æ›´æ–° (fiber.lanes |= lane)

2.æ‰¹å¤„ç†å†³ç­–é˜¶æ®µ
```js
function scheduleUpdateOnFiber(fiber, lane, eventTime) {
  // æ£€æŸ¥æ˜¯å¦åœ¨æ‰¹å¤„ç†ä¸Šä¸‹æ–‡ä¸­
  if (isInsideEventHandler) {
    // ğŸ…°ï¸ æ‰¹å¤„ç†æ¨¡å¼ï¼šæ ‡è®°ä¸ºå¾…å¤„ç†
    markRootUpdated(root, lane, eventTime);
  } else {
    // ğŸ…±ï¸ éæ‰¹å¤„ç†ï¼šç«‹å³è°ƒåº¦
    ensureRootIsScheduled(root, eventTime);
  }
}
```

3.çŠ¶æ€åˆå¹¶é˜¶æ®µ
```js
function processUpdateQueue(workInProgress, props, instance, renderLanes) {
  const queue = workInProgress.updateQueue;
  let baseState = queue.baseState;
  
  // éå†æ›´æ–°é˜Ÿåˆ—
  let update = queue.first;
  while (update !== null) {
    // åˆå¹¶çŠ¶æ€æ›´æ–°
    if (typeof update.payload === 'function') {
      // å‡½æ•°å¼æ›´æ–°
      baseState = update.payload(baseState);
    } else {
      // å¯¹è±¡åˆå¹¶
      baseState = Object.assign({}, baseState, update.payload);
    }
    update = update.next;
  }
  
  // ä¿å­˜æœ€ç»ˆçŠ¶æ€
  workInProgress.memoizedState = baseState;
}
```

4.åè°ƒæ¸²æŸ“é˜¶æ®µ
```js
function performConcurrentWorkOnRoot(root) {
  // æ„å»º workInProgress æ ‘
  renderRootSync(root, lanes);
  
  // æ‰§è¡Œåè°ƒç®—æ³•
  workLoopSync();
  
  // æäº¤å‡†å¤‡
  prepareFreshStack(root, lanes);
}
```

Fiber åè°ƒæµç¨‹:

è°ƒç”¨ beginWork å¤„ç†ç»„ä»¶æ›´æ–°

æ‰§è¡Œ completeWork åˆ›å»º DOM èŠ‚ç‚¹

ç”Ÿæˆ effectListï¼ˆå˜æ›´é“¾è¡¨ï¼‰

5.æäº¤æ›´æ–°é˜¶æ®µ
```js
// é˜¶æ®µ1: Before mutation
  commitBeforeMutationEffects();
  
  // é˜¶æ®µ2: Mutation
  commitMutationEffects(root, renderPriorityLevel);
  
  // é˜¶æ®µ3: Layout
  commitLayoutEffects(root, lanes);
```

æäº¤ä¸‰é˜¶æ®µ:

Before mutation:

è°ƒç”¨ getSnapshotBeforeUpdate

æš‚åœ useLayoutEffect æ¸…ç†å‡½æ•°

Mutation:

æ‰§è¡Œ DOM æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰

è°ƒç”¨ useEffect æ¸…ç†å‡½æ•°

Layout:

è°ƒç”¨ componentDidMount/Update

æ‰§è¡Œ useLayoutEffect å›è°ƒ

æ›´æ–° refs



```mermaid
sequenceDiagram
    participant UserCode
    participant ReactCore
    participant Scheduler
    participant Renderer
    
    UserCode->>ReactCore: setState() è°ƒç”¨
    ReactCore->>ReactCore: åˆ›å»ºæ›´æ–°å¯¹è±¡
    ReactCore->>ReactCore: åŠ å…¥æ›´æ–°é˜Ÿåˆ—
    ReactCore->>ReactCore: æ ‡è®°fiberè„çŠ¶æ€
    
    alt åœ¨æ‰¹å¤„ç†ä¸Šä¸‹æ–‡ä¸­
        ReactCore-->>Scheduler: å»¶è¿Ÿè°ƒåº¦(å¾®ä»»åŠ¡å»¶è¿Ÿ)
    else éæ‰¹å¤„ç†ä¸Šä¸‹æ–‡
        ReactCore->>Scheduler: ç«‹å³è°ƒåº¦(äº‹ä»¶å¾ªç¯å•æ¬¡è§¦å‘)
    end
    
    Scheduler->>Scheduler: åˆå¹¶ä»»åŠ¡é˜Ÿåˆ—
    Scheduler->>ReactCore: æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡
    ReactCore->>ReactCore: åè°ƒé˜¶æ®µï¼ˆå¯ä¸­æ–­ï¼‰
    ReactCore->>Renderer: æäº¤DOMå˜æ›´
    Renderer->>Browser: æ›´æ–°çœŸå®DOM
```

å¼‚æ­¥æ‰¹å¤„ç†æœºåˆ¶ï¼š
- ç›®çš„ï¼šå‡å°‘ä¸å¿…è¦çš„DOMæ›´æ–°
- å¤šä¸ªsetStateåˆå¹¶ï¼Œåªæ¸²æŸ“ä¸€æ¬¡ç»„ä»¶
- ç‰¹åˆ«åœ¨äº‹ä»¶å›è°ƒã€ç”Ÿå‘½å‘¨æœŸè¡¨ç°æ˜æ˜¾
- æ³¨æ„ï¼š`setState((prev)=>prev+1)`ä¼šæ­£ç¡®å åŠ 

## 12.è™šæ‹ŸDOMçš„diffä¸åŸç†ï¼ˆå¦‚å±‚çº§æ¯”è¾ƒã€keyå€¼ä½œç”¨ï¼‰

diffçš„åŸºæœ¬åŸç†
1. åŒä¸€å±‚çº§æ¯”è¾ƒ
   - Reactè®¤ä¸ºDomæ ‘ä¸­æ¯å±‚çš„èŠ‚ç‚¹éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå±‚çº§æ¯”è¾ƒå³åœ¨ç»Ÿä¸€å±‚çº§ä¸Šè¿›è¡ŒèŠ‚ç‚¹çš„é€ä¸ªæ¯”è¾ƒã€‚å¦‚æœèŠ‚ç‚¹ç±»å‹ç›¸åŒï¼Œåˆ™æ›´æ–°æ”¹èŠ‚ç‚¹ï¼›å¦‚æœç±»å‹ä¸åŒï¼Œåˆ™åˆ é™¤æ—§èŠ‚ç‚¹ï¼Œæ’å…¥æ–°èŠ‚ç‚¹ã€‚
2. é€’å½’æ¯”è¾ƒå­æ ‘
   - å¦‚æœä¸¤æ ‘ç±»å‹ç›¸åŒï¼ŒReactä¼šç»§ç»­é€’å½’æ¯”è¾ƒå®ƒä»¬çš„å­èŠ‚ç‚¹ï¼Œæ›´æ–°æˆ–è€…åˆ é™¤å­èŠ‚ç‚¹ã€‚å¦åˆ™ï¼Œä¼šè·³è¿‡è¯¥æ ‘æ¯”è¾ƒï¼Œç›´æ¥é”€æ¯å¹¶æ›¿æ¢æ‰æ—§çš„å­æ ‘ã€‚
3. é€ä¸ªæ¯”è¾ƒèŠ‚ç‚¹çš„å±æ€§
   - åœ¨æ›´æ–°èŠ‚ç‚¹æ—¶ï¼Œä¼šé€šè¿‡æ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹çš„å±æ€§ï¼ˆclassnameã€styleã€childrenç­‰ï¼‰ï¼Œæ›´æ–°èŠ‚ç‚¹çš„å±æ€§ã€‚å¦‚æœå±æ€§å‘ç”Ÿå˜åŒ–ï¼ŒReactä¼šæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯é‡æ–°æ¸²æŸ“æ•´ä¸ªèŠ‚ç‚¹ã€‚
4. å¯¹æ¯”å…ƒç´ ç±»å‹
   - å¦‚æœèŠ‚ç‚¹ç±»å‹ï¼ˆæ¯”å¦‚`<div> <span>`ä¸åŒï¼ŒReactä¼šé”€æ¯æ—§èŠ‚ç‚¹ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒReactä¿è¯ä¸ä¼šé”™è¯¯åœ°å¤ç”¨ä¸ç›¸å¹²çš„ç»„ä»¶ã€‚

å±‚çº§æ¯”è¾ƒå’Œkeyçš„ä½œç”¨
- åŒçº§æ¯”è¾ƒå¯ä»¥å¤§å¤§å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“
- keyè·Ÿè¸ªæ¯ä¸ªå…ƒç´ çš„èº«ä»½ï¼Œé¿å…é”™è¯¯åœ°å¤ç”¨å…ƒç´ ã€‚æé«˜æ¯”è¾ƒæ•ˆç‡ã€‚é¿å…ä¸å¿…è¦çš„ç»„ä»¶çš„æ¸²æŸ“ã€‚æé«˜æ€§èƒ½ã€‚

reactå¯¹diffç®—æ³•çš„ä¼˜åŒ–
1. å…ƒç´ çš„æ’åºï¼šé¿å…å¯¹æ‰€æœ‰èŠ‚ç‚¹çš„å¯¹æ¯”ï¼Œåªå¯¹ç›¸åŒç±»å‹çš„èŠ‚ç‚¹è¿›è¡Œæ·±åº¦æ¯”è¾ƒï¼Œè·³è¿‡ä¸ç›¸å…³çš„éƒ¨åˆ†ã€‚
2. åŒå±‚æ¯”è¾ƒã€‚å‡è®¾ä¸åŒå±‚çº§èŠ‚ç‚¹é€šå¸¸ä¸å‘ç”Ÿå˜åŒ–ã€‚å› æ­¤å®ƒåªä¼šåœ¨åŒä¸€å±‚çº§å†…æ¯”è¾ƒèŠ‚ç‚¹ã€‚ä¸åŒå±‚çº§èŠ‚ç‚¹ç›´æ¥é”€æ¯é‡å»ºã€‚
3. ç»„ä»¶çš„å¤ç”¨ï¼Œé€šè¿‡Keyä¿è¯åˆ—è¡¨å…ƒç´ çš„å¤ç”¨ï¼Œå‡å°‘åˆ—è¡¨æ¸²æŸ“æ—¶çš„æ€§èƒ½å¼€é”€ã€‚
4. æœ€å°åŒ–æ›´æ–°ï¼šé€šè¿‡ç²¾ç¡®çš„å·®å¼‚è®¡ç®—ï¼ŒReactèƒ½å¤Ÿåœ¨æœ€å°åŒ–æ›´æ–°çš„åŒæ—¶ä¿è¯é¡µé¢çš„ä¸€è‡´æ€§å’Œæ€§èƒ½ã€‚åªä¼šå‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†è¿›è¡Œæ›´æ–°ï¼Œä»è€Œé¿å…å¤§é‡çš„é‡å¤æ“ä½œã€‚

```mermaid
graph LR
A[æ–°æ—§è™šæ‹ŸDOMæ ‘] --> B[Diffç®—æ³•]
B --> C[æ‰¾å‡ºæœ€å°å˜æ›´é›†]
C --> D[é«˜æ•ˆæ›´æ–°çœŸå®DOM]
```

æºç å¯¼è¯»
è·¯å¾„:`packages/react-reconciler/src/ReactFiberBeginWork.old.js`

|å‚æ•°|å…³é”®ä½œç”¨|å½±å“diffè¡Œä¸º|
| ---|---|---|
| current | æä¾›æ—§Fiberæ ‘ç»“æ„| å†³å®šå¤ç”¨å¯èƒ½æ€§|
| workInProgress | æ‰¿è½½æ–°Fiberæ„å»º| Diffç»“æœå®¹å™¨|
| nextChildren | æä¾›æ–°è™šæ‹ŸDomç»“æ„| Diffçš„ç›®æ ‡|
| renderLanes | ç¡®å®šæ¸²æŸ“ä¼˜å…ˆçº§| æ§åˆ¶diffæ·±åº¦å’ŒèŒƒå›´|
```js
function reconcileChildren(
  current: Fiber | null, 
  workInProgress: Fiber, 
  nextChildren: any, 
  renderLanes: Lanes
) {
  if (current === null) {
    // æŒ‚è½½é˜¶æ®µ
    workInProgress.child = mountChildFibers(
      workInProgress, 
      null, 
      nextChildren, 
      renderLanes
    );
  } else {
    // æ›´æ–°é˜¶æ®µï¼ˆDiffæ ¸å¿ƒï¼‰
    workInProgress.child = reconcileChildFibers(
      workInProgress,
      current.child,
      nextChildren,
      renderLanes
    );
  }
}
```

### ğŸ”¥ä¸‰å¤§ç­–ç•¥

1ï¸âƒ£ åŒçº§æ¯”è¾ƒç­–ç•¥

```js
function reconcileChildFibers(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  newChild: any,
  lanes: Lanes
): Fiber | null {
  // ç­–ç•¥1ï¼šå•èŠ‚ç‚¹Diff
  if (typeof newChild === 'object' && newChild !== null) {
    switch (newChild.$$typeof) {
      case REACT_ELEMENT_TYPE:
        return placeSingleChild(
          reconcileSingleElement(
            returnFiber,
            currentFirstChild,
            newChild,
            lanes
          )
        );
    }
  }
  
  // ç­–ç•¥2ï¼šå¤šèŠ‚ç‚¹Diff
  if (isArray(newChild)) {
    return reconcileChildrenArray(
      returnFiber,
      currentFirstChild,
      newChild,
      lanes
    );
  }
  
  // ...å…¶ä»–ç±»å‹å¤„ç†
}
```

2ï¸âƒ£ ç»„ä»¶ç±»å‹åˆ¤æ–­
```js
function reconcileSingleElement(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  element: ReactElement,
  lanes: Lanes
): Fiber {
  const key = element.key;
  let child = currentFirstChild;
  
  // éå†æ—§å­èŠ‚ç‚¹
  while (child !== null) {
    if (child.key === key) {
      // KEYç›¸åŒ
      if (child.elementType === element.type) {
        // ç±»å‹ç›¸åŒ â†’ å¤ç”¨èŠ‚ç‚¹
        deleteRemainingChildren(returnFiber, child.sibling);
        const existing = useFiber(child, element.props);
        existing.ref = coerceRef(returnFiber, child, element);
        existing.return = returnFiber;
        return existing;
      } else {
        // ç±»å‹ä¸åŒ â†’ åˆ é™¤æ—§èŠ‚ç‚¹
        deleteRemainingChildren(returnFiber, child);
        break;
      }
    } else {
      // KEYä¸åŒ â†’ åˆ é™¤æ—§èŠ‚ç‚¹
      deleteChild(returnFiber, child);
    }
    child = child.sibling;
  }
  
  // åˆ›å»ºæ–°èŠ‚ç‚¹
  const created = createFiberFromElement(element, returnFiber.mode, lanes);
  created.ref = coerceRef(returnFiber, currentFirstChild, element);
  created.return = returnFiber;
  return created;
}
```

3ï¸âƒ£ Key ä¼˜åŒ–ç­–ç•¥
```js 
function reconcileChildrenArray(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  newChildren: Array<*>,
  lanes: Lanes
): Fiber | null {
  // ç”Ÿæˆæ—§èŠ‚ç‚¹Map {key: Fiber}
  const existingChildren = mapRemainingChildren(returnFiber, currentFirstChild);
  
  for (; newIdx < newChildren.length; newIdx++) {
    const newFiber = updateFromMap(
      existingChildren,
      returnFiber,
      newIdx,
      newChildren[newIdx],
      lanes
    );
    
    if (newFiber !== null) {
      if (shouldTrackSideEffects) {
        if (newFiber.alternate !== null) {
          // èŠ‚ç‚¹å¤ç”¨ â†’ ä»Mapä¸­åˆ é™¤
          existingChildren.delete(
            newFiber.key === null ? newIdx : newFiber.key
          );
        }
      }
      
      // æ£€æŸ¥èŠ‚ç‚¹ç§»åŠ¨
      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);
    }
  }
  
  // åˆ é™¤æœªä½¿ç”¨çš„æ—§èŠ‚ç‚¹
  existingChildren.forEach(child => deleteChild(returnFiber, child));
}
```

Diffæ ¸å¿ƒç®—æ³•ï¼š`placeChild`
```js
function placeChild(
  newFiber: Fiber,
  lastPlacedIndex: number,
  newIndex: number
): number {
  newFiber.index = newIndex;
  
  const current = newFiber.alternate;
  if (current !== null) {
    const oldIndex = current.index;
    if (oldIndex < lastPlacedIndex) {
      // ç§»åŠ¨èŠ‚ç‚¹ â†’ æ·»åŠ  Placement flag
      newFiber.flags |= Placement;
      return lastPlacedIndex;
    } else {
      // ä½ç½®ä¸å˜
      return oldIndex;
    }
  } else {
    // æ–°å¢èŠ‚ç‚¹ â†’ æ·»åŠ  Placement flag
    newFiber.flags |= Placement;
    return lastPlacedIndex;
  }
}
```

ğŸ”„ Diff å…¨æµç¨‹
```mermaid
sequenceDiagram
    participant Scheduler
    participant Reconciler
    participant DiffAlgo
    participant FiberTree
    
    Scheduler->>Reconciler: å¼€å§‹æ¸²æŸ“ï¼ˆrenderLanesï¼‰
    Reconciler->>DiffAlgo: reconcileChildFibers()
    
    loop èŠ‚ç‚¹Diff
        DiffAlgo->>DiffAlgo: æ¯”è¾ƒèŠ‚ç‚¹key/type
        alt èŠ‚ç‚¹å¯å¤ç”¨
            DiffAlgo->>FiberTree: å¤ç”¨FiberèŠ‚ç‚¹
        else èŠ‚ç‚¹éœ€æ›´æ–°
            DiffAlgo->>FiberTree: æ ‡è®°æ›´æ–°(flags)
        else èŠ‚ç‚¹éœ€ç§»åŠ¨
            DiffAlgo->>FiberTree: æ ‡è®°ç§»åŠ¨(Placement)
        else èŠ‚ç‚¹éœ€åˆ é™¤
            DiffAlgo->>FiberTree: æ ‡è®°åˆ é™¤(Deletion)
        end
    end
    
    Reconciler->>Scheduler: å®ŒæˆDiffï¼ˆeffectListï¼‰
```

ğŸ’¡ Diff ç»“æœæäº¤
```js
function commitMutationEffects(
  root: FiberRoot,
  firstChild: Fiber,
  committedLanes: Lanes
) {
  let fiber = firstChild;
  while (fiber !== null) {
    // å¤„ç†æ’å…¥/ç§»åŠ¨
    if (fiber.flags & Placement) {
      commitPlacement(fiber);
    }
    // å¤„ç†åˆ é™¤
    if (fiber.flags & Deletion) {
      commitDeletion(root, fiber);
    }
    // å¤„ç†æ›´æ–°
    if (fiber.flags & Update) {
      commitWork(fiber);
    }
    fiber = fiber.sibling;
  }
}
```

### æ€»ç»“React18çš„diffåŸç†
1.åŒæŒ‡é’ˆéå†
- æ–°æ—§åŒæ—¶éå†
- é€šè¿‡oldIndexå’ŒnewIndexåˆ¤æ–­ç§»åŠ¨

```js
// åœºæ™¯1:ä¸¾ä¾‹ åˆ—è¡¨å¤´éƒ¨æ’å…¥
// æ—§ Bã€C
// æ–° Aã€Bã€C
1. Bï¼ˆæ—§ï¼‰ VS Aï¼ˆæ–°ï¼‰ ä¸­æ–­
2.map ä¿å­˜æ—§ï¼Œ éå†æ–°èŠ‚ç‚¹ï¼Œå¤ç”¨ Bã€C
3.åˆ›å»ºA -> æ ‡è®°Placement(æ’å…¥å¤´éƒ¨)
```

```js
//åœºæ™¯2
// æ—§: [A, B, C, D]
// æ–°: [A, C, D]

1. A å¤ç”¨
2.B(æ—§) vs C(æ–°) keyä¸åŒï¼Œä¸­æ–­
3.æ”¶é›†æ—§ï¼Œéå†æ–°ï¼Œå¤ç”¨Cã€D
4.åˆ é™¤B
```

å…³é”®è®¾è®¡æ€æƒ³

1.ç§»åŠ¨ä¼˜åŒ–åˆ é™¤é‡å»º;ä½ç½®ç´¢å¼•è¿½è¸ªï¼›æ‰¹å¤„ç†ç§»åŠ¨æ“ä½œ`commitPlacement`

2.ä¸‰å±‚ä¼˜åŒ–ç­–ç•¥
- åŒçº§æ¯”è¾ƒ
- ç±»å‹æ¯”è¾ƒ
- keyä¼˜åŒ–
3.Fiberé“¾è¡¨ç»“æ„
- é€šè¿‡childrenã€siblingã€returnå…³è”
- å¢é‡diffï¼ˆå¯ä¸­æ–­å›å¤ï¼‰ ï¼Ÿï¼Ÿ
4.Laneä¼˜å…ˆçº§ ï¼ˆä¹Ÿä¼šå½±å“diffçš„èŒƒå›´å’Œæ·±åº¦ï¼‰ ï¼Ÿï¼Ÿ
- é«˜ä¼˜æ›´æ–°ä¼˜å…ˆDiff ï¼Ÿï¼Ÿ
- ä½ä¼˜æ›´æ–°å¯è¢«å¤§æ–­ ï¼Ÿï¼Ÿ
5.Effectæ ‡è®°
- æœ€å°åŒ–Domæ“ä½œ
- æ‰¹é‡æ‰§è¡Œå˜æ›´


## 13.å£°æ˜å‘¨æœŸçš„åˆ’åˆ†

é™„åŠ ï¼šReact çš„ class ç±»æœ‰ä»€ä¹ˆç”Ÿå‘½å‘¨æœŸï¼Ÿ

æ„å»ºï¼ˆconstructor)ï¼š æ´¾(getDerivedStateFromProps) -> ç»˜(render) -> æŒ‚(componentDidMount)
| æ–¹æ³• | è°ƒç”¨æ—¶æœº | ç”¨é€” | æ˜¯å¦å¯è°ƒç”¨ setState |
| ---- | ---- | ---- | ---- |
| constructor | ç»„ä»¶åˆå§‹åŒ– | åˆå§‹åŒ– stateï¼Œç»‘å®šæ–¹æ³• | âŒ |
| getDerivedStateFromProps | æ¯æ¬¡æ¸²æŸ“å‰ | æ ¹æ® props æ›´æ–° state | âŒ |
| render | å¿…é¡»å®ç°çš„æ–¹æ³• | è¿”å› jsx | âŒ |
| componententDidMount | ç»„ä»¶æŒ‚è½½å | DOM æ“ä½œã€ç½‘ç»œè¯·æ±‚ã€è®¢é˜… | âœ… |

å˜æ›´ ï¼š æ´¾(getDerivedStateFromProps) -> åˆ¤(shouldComponentUpdate) -> ç»˜(render) -> æ•(getSnapShotBeforeUpdate) -> æ›´(componentDidUpdate)
| æ–¹æ³• | è°ƒç”¨æ—¶æœº | ç”¨é€” | æ˜¯å¦å¯è°ƒç”¨ setState |
| ---- | ---- | ---- | ---- |
| getDerivedStateFromProps | æ¯æ¬¡æ¸²æŸ“å‰ | æ ¹æ® props æ›´æ–° state | âŒ |
| shouldComponentUpdate | æ›´æ–°å‰ | æ€§èƒ½ä¼˜åŒ–ï¼Œæ§åˆ¶æ˜¯å¦æ¸²æŸ“ | âŒ |
| render | å¿…é¡»å®ç°çš„æ–¹æ³• | è¿”å› jsx | âŒ |
| getSnapShotBeforeUpdate | Dom æ›´æ–°å‰ | è·å– DOM çš„å¿«ç…§ä¿¡æ¯ | âŒ |
| componentDidUpdate | æ›´æ–°å®Œæˆå | DOM æ“ä½œï¼Œç½‘ç»œè¯·æ±‚ | âœ… |

å¸è½½ï¼š æ¸…(componentWillUnmount)
| æ–¹æ³• | è°ƒç”¨æ—¶æœº | ç”¨é€” | æ˜¯å¦å¯è°ƒç”¨ setState |
| ---- | ---- | ---- | ---- |
| componentWillUnmount | ç»„ä»¶å¸è½½å‰ | æ¸…ç†æ“ä½œï¼ˆè®¡æ—¶å™¨ï¼Œè®¢é˜…ï¼‰ | âŒ |

é”™è¯¯å¤„ç†ï¼š æ´¾(getDerivedStateFromError) -> è®°(componentDidCatch)

| æ–¹æ³•                     | è°ƒç”¨æ—¶æœº           | ç”¨é€”         | æ˜¯å¦å¯è°ƒç”¨ setState |
| ------------------------ | ------------------ | ------------ | ------------------- |
| getDerivedStateFromError | åä»£ç»„ä»¶æŠ›å‡ºé”™è¯¯å | æ¸²æŸ“å¤‡ç”¨ UI  |                     |
| componententDidCatch     | åä»£ç»„ä»¶æŠ›å‡ºé”™è¯¯å | è®°å½•é”™è¯¯å½¢è±¡ |                     |

é™„åŠ ï¼šclass çš„ç”Ÿå‘½å‘¨æœŸæ€ä¹ˆä½¿ç”¨ hook çš„å¯¹æ¯”

| æ–¹æ³•                     | hook                     | xx  | xx  |
| ------------------------ | ------------------------ | --- | --- |
| constructor              | useState åˆå§‹åŒ–          | xx  | xx  |
| getDerivedStateFromProps | useState+useEffect       | xx  | xx  |
| render                   | å‡½æ•°ç»„ä»¶æœ¬èº«             | xx  | xx  |
| componententDidMount     | useEffect                | xx  | xx  |
| shouldComponentUpdate    | useMemo                  | xx  | xx  |
| componententDidUpdate    | useEffect                | xx  | xx  |
| componententDidUnmount   | useEffect è¿”å›çš„æ¸…ç†å‡½æ•° | xx  | xx  |


## 14.ä¸ºä»€ä¹ˆAJAXè¯·æ±‚æ”¾åœ¨`componentDidMount`?
- domå·²ç»åŠ è½½å®Œæˆï¼šè¯¥æ–¹æ³•åœ¨ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“å®Œæˆä¹‹åè°ƒç”¨ï¼Œé¿å…è®¿é—®æœªæ¸²æŸ“DOMçš„é—®é¢˜
- é¿å…é‡å¤è¯·æ±‚ï¼šç›¸æ¯”æ”¾åœ¨renderï¼ŒcomponentDidMountåªæ‰§è¡Œä¸€æ¬¡ï¼Œé¿å…è¯·æ±‚é‡å¤å‘å™¨ã€‚
- ç¬¦åˆå‰¯ä½œç”¨å¤„ç†è§„èŒƒï¼šReactæ¨èå°†å‰¯ä½œç”¨ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ï¼‰å†™åœ¨é’©å­ä¸­ï¼Œä¸å‡½æ•°ç»„ä»¶ä¸­çš„`useEffect`ç”¨æ³•ä¸€è‡´ã€‚

## 15.shouldComponentUpdateçš„ä½œç”¨ä»¥åŠå¦‚ä½•é€šè¿‡å®ƒä¼˜åŒ–æ€§èƒ½ï¼Ÿ
`shouldComponentUpdate(nextProps,nextState)`æ–¹æ³•æ˜¯ç”¨æ¥æ‹¦æˆªæ›´æ–°ç”¨çš„ã€‚è¿”å›booleanã€‚
ä¼˜åŒ–æ–¹å¼ï¼š
- é¿å…ä¸å¿…è¦æ¸²æŸ“
- ç»“åˆä¸å¯å˜æ•°æ®(immutable)å’Œ(PureComponent)è¿›è¡Œä¼˜åŒ–ã€‚

## 16.Reactçš„keyå€¼åœ¨åˆ—è¡¨æ¸²æŸ“ä¸­çš„ä½œç”¨ä»¥åŠæœ€ä½³å®è·µ
åœ¨åŠ¨æ€æ¸²æŸ“åˆ—è¡¨ï¼Œkeyå¸®åŠ©Reacté«˜æ•ˆè¯†åˆ«å“ªäº›åˆ—è¡¨é¡¹æ”¹å˜ã€æ·»åŠ æˆ–è€…åˆ é™¤ï¼Œä»è€Œé¿å…ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œå¹¶ä¼˜åŒ–æ€§èƒ½ã€‚

keyçš„ä½œç”¨ï¼š
- å”¯ä¸€æ ‡è¯†åˆ—è¡¨é¡¹
- æå‡æ€§èƒ½å’Œé¿å…ä¸å¿…è¦çš„æ¸²æŸ“
- ç¡®ä¿ç»„ä»¶æ­£ç¡®å¤ç”¨

keyçš„å·¥ä½œåŸç†ï¼š

reactåœ¨åˆ—è¡¨æ¸²æŸ“æ—¶çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š
- å¯¹æ¯”ä¸¤é¢—è™šæ‹Ÿdomæ ‘ï¼šå½“ç»„ä»¶çŠ¶æ€æˆ–è€…propså‘ç”Ÿå˜åŒ–æ—¶ï¼ŒReactä¼šåˆ›å»ºæ–°çš„è™šæ‹ŸDOMæ ‘ï¼Œå¹¶å°†å…¶ä¸ä¹‹å‰çš„è™šæ‹ŸDOMæ ‘è¿›è¡Œå¯¹æ¯”ï¼ŒæŸ¥æ‰¾å·®å¼‚ã€‚
- åŒ¹é…å…ƒç´ ã€‚åªæœ‰keyç›¸åŒæ‰èƒ½è¢«è®¤ä¸ºç›¸åŒçš„ã€‚
- æ›´æ–°å˜åŒ–çš„å…ƒç´ ã€‚æ ¹æ®keyçš„æ¯”è¾ƒç»“æœï¼Œåªæ›´æ–°é‚£äº›éœ€è¦å˜åŒ–çš„DOMå…ƒç´ ï¼Œè€Œä¸æ˜¯é‡æ–°æ¸²æŸ“åˆ—è¡¨ã€‚

æœ€ä½³å®è·µï¼š

- ç¡®ä¿å…ƒç´ å”¯ä¸€keyã€‚
- æ•°ç»„é¿å…ä½¿ç”¨ç´¢å¼•åškeyã€‚
- ä½¿ç”¨ç¨³å®šçš„keyã€‚
- ç¡®ä¿keyåœ¨åŒä¸€å±‚çº§å†…å”¯ä¸€ã€‚å½“å¤šå±‚åµŒå¥—åˆ—è¡¨æ—¶ï¼Œå¯ä»¥ä¸ºæ¯ä¸€å±‚ä½¿ç”¨ä¸åŒçš„keyè§„åˆ™