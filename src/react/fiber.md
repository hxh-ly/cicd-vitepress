## React Fiber æ¶æ„çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ

ç›®æ ‡ï¼š æå‡æ€§èƒ½å’Œå“åº”æ€§ã€‚

ä½“ç°ï¼š

- å¢é‡æ¸²æŸ“ fiberã€‚å…è®¸æ¸²æŸ“å·¥ä½œåˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œç„¶åæŠŠæ¸²æŸ“ä»»åŠ¡åˆ†æ•£åˆ°å¤šä¸ªå¸§ä¸­å»æ‰§è¡Œï¼Œé¿å…é•¿æ—¶é—´æ¸²æŸ“ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹ã€‚
- ä¼˜å…ˆçº§è°ƒåº¦ã€‚å¼•å…¥ä¼˜å…ˆçº§ï¼Œä½¿å¾— react å¯ä»¥é€šè¿‡ä»»åŠ¡ä¼˜å…ˆçº§ä¼˜å…ˆå¤„ç†é«˜ä¼˜ä»»åŠ¡ï¼ˆç”¨æˆ·è¾“å…¥/åŠ¨ç”»ï¼‰ã€‚
- å¯ä¸­æ–­æ¢å¤æ¸²æŸ“ã€‚fiber ä½¿å¾—åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œfiber æ‰§è¡Œä»»åŠ¡å¯ä¸­æ–­å’Œæ¢å¤ã€‚æ„å‘³ç€ react å¯ä»¥åœ¨å¤„ç†å¤æ‚æ›´æ–°çš„æ—¶å€™ï¼Œå¯ä»¥ä¸­æ–­å½“å‰ä»»åŠ¡ã€‚å¤„ç†æ›´åŠ ç´§æ€¥çš„ä»»åŠ¡ã€‚

æºç ç›¸å…³æ¦‚å¿µï¼›

- fiber èŠ‚ç‚¹ï¼šæ¯ä¸ªç»„ä»¶å¯¹ä¸€ä¸ª fiber èŠ‚ç‚¹ï¼ˆçŠ¶æ€å±æ€§ã€å­èŠ‚ç‚¹ä¿¡æ¯ï¼‰
- åŒç¼“å†²æœºåˆ¶ï¼šç»´æŠ¤ä¸¤é¢—æ ‘`å½“å‰æ ‘`å’Œ`æ­£åœ¨æ‰§è¡Œçš„æ ‘`,æ›´æ–°çš„æ—¶å€™ react ä¼šåœ¨ æ­£åœ¨æ‰§è¡Œçš„æ ‘ä¸Šæ“ä½œï¼Œç­‰å¾…æ›´æ–°å®Œæˆä¹‹åï¼Œåœ¨æŠŠå®ƒæ›¿æ¢ä¸ºå½“å‰çš„æ ‘ï¼Œè¿™æ ·å°±å®ç°å¹³æ»‘è¿‡åº¦äº†ã€‚
- è°ƒåº¦å™¨ï¼šä¸»è¦å¤æ‚ç®¡ç†ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡èƒ½å¤ŸåŠæ—¶æ‰§è¡Œï¼Œé¿å…ä½ä¼˜å…ˆçº§é˜»å¡å…³é”®æµç¨‹ã€‚
- å‰¯ä½œç”¨é“¾ï¼šåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ä¼šæ”¶é›†å‰¯ä½œç”¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨ã€‚æ¸²æŸ“å®Œæˆä¹‹åï¼Œç»Ÿä¸€æ‰§è¡Œï¼Œç¡®ä¿äº†å‰¯ä½œç”¨çš„é¡ºåºå’Œä¸€è‡´æ€§ã€‚

## Fiber åŒç¼“å†²æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ

å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ç»´æŠ¤ä¸¤æ£µ Fiber æ ‘ï¼ˆcurrent æ ‘å’Œ workInProgress æ ‘ï¼‰ï¼Œé€šè¿‡ â€œåå°æ„å»ºã€å‰å°æ›¿æ¢â€ çš„æ–¹å¼ï¼Œé¿å…æ¸²æŸ“è¿‡ç¨‹ä¸­æš´éœ²ä¸­é—´çŠ¶æ€ï¼ŒåŒæ—¶å‡å°‘ DOM æ“ä½œçš„å¼€é”€ã€‚

- `current`æ ‘ï¼šå¯¹åº”å½“å‰å±å¹•å·²æ¸²æŸ“çš„ DOM ç»“æ„ï¼Œæ˜¯å·²æäº¤çš„çŠ¶æ€ç¨³å®šçŠ¶æ€ã€‚æ ‘ä¸Šçš„æ¯ä¸€ä¸ª Fiber èŠ‚ç‚¹éƒ½æ ‡è®°äº†å½“å‰ DOM çš„å±æ€§å’Œå…³ç³»ã€‚
- `workInProgress`æ ‘ï¼šæ­£åœ¨å†…å­˜ä¸­æ„å»ºçš„æ–°æ ‘ï¼Œç”¨ä¸è®¡ç®—æœ€æ–°çš„æ¸²æŸ“çŠ¶æ€ï¼ˆå¤„ç† propsã€state æ›´æ–°ç­‰ï¼‰ã€‚æ„å»ºè¿‡ç¨‹ä¸ä¼šç›´æ¥æ“ä½œ DOMï¼Œè€Œæ˜¯ç°åœ¨å†…å­˜ä¸­å®Œæˆè®¡ç®—å’Œå·®å¼‚æ ‡è®°ã€‚
- `alternate`:ä¸¤é¢—æ ‘çš„ Fiber èŠ‚ç‚¹é€šè¿‡`alternate`å±æ€§ç›¸äº’å…³è”(currentFiber.alternate = workInprogressFiber,åä¹‹äº¦ç„¶)ï¼Œç”¨äºå¤ç”¨èŠ‚ç‚¹ä¿¡æ¯ï¼Œå‡å°‘å†…å­˜å¼€é”€
  ä»·å€¼ï¼š

1. é¿å…ä¸­é—´çŠ¶æ€æš´éœ²ã€‚workInProgress æ ‘åœ¨å†…å­˜ä¸­æ„å»ºï¼Œåªæœ‰å½“å®Œå…¨å°±ç»ªåæ‰æ›¿æ¢ current æ ‘å¹¶æ›´æ–° DOMï¼Œç”¨æˆ·çœ‹åˆ°çš„å§‹ç»ˆæ˜¯å®Œæ•´ã€ä¸€è‡´çš„ç•Œé¢ï¼Œä¸ä¼šå‡ºç° â€œåŠæ›´æ–°â€ çš„é”™ä¹±çŠ¶æ€ã€‚
2. å‡å°‘ DOM æ“ä½œå¼€é”€ã€‚é€šè¿‡å¤ç”¨æœªå˜åŒ–çš„èŠ‚ç‚¹ï¼ˆåˆ©ç”¨ alternate æŒ‡é’ˆï¼‰å’Œç²¾å‡†æ ‡è®°å·®å¼‚ï¼ˆeffectTagï¼‰ï¼Œåªæ›´æ–°å¿…è¦çš„ DOM å…ƒç´ ï¼Œé¿å…å…¨é‡é‡ç»˜ã€‚
3. æ”¯æŒå¯ä¸­æ–­æ¸²æŸ“ã€‚workInProgress æ ‘çš„æ„å»ºè¿‡ç¨‹å¯ä»¥è¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰ä¸­æ–­ï¼Œæ¢å¤æ—¶å¯åŸºäºå·²æ„å»ºçš„éƒ¨åˆ†ç»§ç»­ï¼Œè€Œ current æ ‘å§‹ç»ˆä¿æŒç¨³å®šï¼Œä¿è¯ç•Œé¢ä¸å¡é¡¿ã€‚

## 25.React18 çš„å¹¶å‘æ¨¡å¼å¦‚ä½•ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Ÿ

å¹¶å‘æ¨¡å¼çš„æœ¬è´¨ä¸Šé€šè¿‡ **å¼‚æ­¥æ¸²æŸ“**çš„æ–¹å¼æ¥æå‡ React åº”ç”¨çš„å“åº”æ€§ã€‚ä¼ ç»Ÿ React æ¸²æŸ“ä¸ŠåŒæ­¥çš„ï¼Œè¿™ä¼šå¯¼è‡´ç”¨æˆ·åœ¨é¡µé¢æ¸²æŸ“çš„è¿‡ç¨‹ä¸­çš„å¡é¡¿å’Œå»¶è¿Ÿã€‚

å¹¶å‘æ¨¡å¼å¼•å…¥äº†**ä¼˜å…ˆçº§è°ƒåº¦**å’Œ**æ—¶é—´åˆ†ç‰‡**ï¼Œä½¿å¾— React å¯ä»¥ **æš‚åœ** æŸäº›ä½ä¼˜å…ˆçº§æ¸²æŸ“ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥æˆ–è€…äº¤äº’ï¼‰åˆ°è¾¾ï¼Œèƒ½å¿«é€Ÿå“åº”ï¼Œç”šè‡³åœ¨åå°ç»§ç»­æ¸²æŸ“æœªå®Œæˆçš„ä»»åŠ¡ã€‚è¿™ä½¿å¾— React å¯ä»¥æ›´çµæ´»ç®¡ç†ä¸åŒä»»åŠ¡ä¹‹é—´çš„æ‰§è¡Œé¡ºåºï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒã€‚

å¹¶å‘æ¨¡å¼çš„å‡ ä¸ªå…³é”®ç‰¹æ€§ï¼š

1. **æ¸è¿›å¼æ¸²æŸ“(Incremental Rendering)**
   å¹¶å‘æ¨¡å¼å…è®¸ React å°†æ¸²æŸ“è¿‡ç¨‹åˆ‡åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯ä»¥æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§é€æ­¥æ‰§è¡Œã€‚

2. **ä¼˜å…ˆçº§è°ƒåº¦ (proiority scheduler)**
   ä¸åŒçš„æ¸²æŸ“ä»»åŠ¡å¯ä»¥æ ¹æ®ç´§æ€¥ç¨‹åº¦ä¸åŒåˆ†é…ä¸åŒçš„ä¼˜å…ˆçº§ã€‚ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·è¾“å…¥å†…å®¹ï¼ŒReact ä¼šä¼˜å…ˆå“åº”ç”¨æˆ·è¾“å…¥ï¼Œè€Œå°†å…¶ä»–ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼ˆå¦‚å›¾åƒåŠ è½½ã€åŠ¨ç”»ç­‰ï¼‰æ¨è¿Ÿå¤„ç†ã€‚è¿™ç¡®ä¿ç”¨æˆ·çš„äº¤äº’ä½“éªŒä¸Šæ˜¯å³æ—¶å“åº”çš„ï¼Œå³æ—¶åº”ç”¨åœ¨åå°åšä¸€äº›ç¹é‡çš„è®¡ç®—æˆ–è€…æ¸²æŸ“ã€‚

3. **æ—¶é—´åˆ†ç‰‡**
   å¹¶å‘æ¨¡å¼ä¸‹ï¼ŒReact ä¼šåˆ†å‰²**æ¸²æŸ“ä»»åŠ¡**ä¸ºå¤šä¸ªæ—¶é—´ç‰‡ï¼Œæ¯ä¸€ä¸ªæ—¶é—´ç‰‡æ‰§è¡Œä¸€å°éƒ¨åˆ†ä»»åŠ¡ï¼Œç„¶åè¿”å›æµè§ˆå™¨çº¿ç¨‹ï¼Œè®©æµè§ˆå™¨åšå…¶ä»–äº‹æƒ…ï¼Œå¦‚ç”¨æˆ·è¾“å…¥çš„å“åº”æˆ–è€…ç•Œé¢çš„ç»˜ç”»ã€‚è¿™ç§æ—¶é—´åˆ†ç‰‡çš„æ–¹å¼ä½¿å¾— React å¯ä»¥åœ¨ä¿å­˜å“åº”æ€§çš„åŒæ—¶ï¼Œå®Œæˆé•¿æ—¶é—´çš„è®¡ç®—ä»»åŠ¡æˆ–è€…å¤æ‚çš„é¡µé¢æ¸²æŸ“ã€‚ä¾‹å¦‚ï¼Œå½“è¿›è¡Œå¤æ‚åŠ¨ç”»æ¸²æŸ“æ—¶ï¼ŒReact ä¼šç¡®ä¿ä¸ä¼šé˜»å¡ç”¨æˆ·çš„æ“ä½œï¼Œè®©é¡µé¢æ¸²æŸ“å’Œç”¨æˆ·è¾“å…¥èƒ½å¤Ÿå¹¶è¡Œè¿›è¡Œï¼Œé¿å…é¡µé¢å¡é¡¿æˆ–è€…é•¿æ—¶é—´æ— å“åº”çš„æƒ…å†µã€‚

4. **ç©ºé—²æ—¶é—´ä¼˜åŒ–**
   å½“æµè§ˆå™¨çº¿ç¨‹ç©ºé—²ï¼ŒReact å¯ä»¥åœ¨ç©ºé—²æ—¶æ®µå®Œæˆä¸€äº›é¢å¤–çš„æ¸²æŸ“å·¥ä½œã€‚è¿™æ„å‘³å³ä½¿ç”¨æˆ·æ²¡æœ‰äº¤äº’ï¼ŒReact ä¹Ÿåˆ©ç”¨ç©ºé—²æ—¶é—´é¢„æ¸²æŸ“ä¸‹ä¸€ä¸ªå±å¹•æˆ–è®¡ç®—ä¸€äº›å¤æ‚ä»»åŠ¡ã€‚

5. **å¯ä¸­æ–­æ¸²æŸ“**
   åœ¨å¹¶å‘æ¨¡å¼ä¸­ï¼ŒReact å…è®¸æ¸²æŸ“ä»»åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­å¹¶é‡æ–°è°ƒåº¦ã€‚æŸäº›æ¸²æŸ“ä»»åŠ¡ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰å¯ä»¥åœ¨é«˜ä¼˜å…ˆçº§çš„æƒ…å†µä¸‹æ‰“æ–­å½“å‰è¿›è¡Œçš„æ¸²æŸ“ä»»åŠ¡ã€‚è¿™ç§ä¸­æ–­æ¸²æŸ“æ–¹å¼ä½¿å¾— React å¯ä»¥ä¼˜å…ˆå“åº”ç”¨æˆ·çš„æ“ä½œï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

å¹¶å‘æ¨¡å¼çš„**å®é™…åº”ç”¨**ï¼š

1. suspense å…è®¸å¼€å‘è€…æŒ‡å®šä¸€ä¸ªç»„ä»¶çš„åŠ è½½è¿‡ç¨‹ï¼Œå¹¶ç­‰å¾…æ—¶æ˜¾ç¤ºä¸€ä¸ªåŠ è½½æŒ‡ç¤ºå™¨ï¼ŒReact å¯ä»¥ react åœ¨åå°å¼‚æ­¥åŠ è½½èµ„æºå¹¶åœ¨å‡†å¤‡å¥½æ—¶å³æ—¶æ¸²æŸ“ã€‚
2. React Server Componentsã€‚ æŸäº›ç»„ä»¶çš„æ¸²æŸ“å¯ä»¥åœ¨æœåŠ¡å™¨è¿›è¡Œï¼Œè€Œä¸æ˜¯å®Œå…¨åœ¨æµè§ˆå™¨æ¸²æŸ“ï¼Œä½¿å¾—åº”ç”¨é¦–æ¬¡åŠ è½½æ›´å¿«é€Ÿï¼Œé€šè¿‡å¹¶å‘æ¨¡å¼é…åˆï¼Œserver Components å¯ä»¥å’Œå®¢æˆ·ç«¯æ›´å¥½é…åˆï¼Œä¼˜åŒ–èµ„æºçš„åŠ è½½é¡ºåºå’Œæ¸²æŸ“æ•ˆç‡ï¼Œè¿›ä¸€æ­¥æå‡ç”¨æˆ·çš„ä½“éªŒã€‚

**ä¾‹å­** ğŸ§© 10 ä¸‡æ¡æ¸²æŸ“å…¨æµç¨‹

```mermaid
graph TD
    A[setState æ›´æ–°åˆ—è¡¨] --> B{è°ƒåº¦å™¨}
    B -->|é«˜ä¼˜å…ˆçº§| C[ç”¨æˆ·äº¤äº’ä»»åŠ¡]
    B -->|ä½ä¼˜å…ˆçº§| D[10ä¸‡æ¡æ¸²æŸ“]
    D --> E[æ—¶é—´åˆ†ç‰‡]
    E -->|æ¯5ms| F{å¯ä¸­æ–­ç‚¹}
    F -->|æœ‰å‰©ä½™æ—¶é—´| G[ç»§ç»­æ¸²æŸ“]
    F -->|æ— å‰©ä½™æ—¶é—´| H[æš‚åœæ¸²æŸ“]
    H --> I[è¿”è¿˜æ§åˆ¶æƒç»™æµè§ˆå™¨]
    I --> J{ä¸‹ä¸€å¸§}
    J -->|æµè§ˆå™¨ç©ºé—²| E
    J -->|ç”¨æˆ·äº¤äº’| C
    G --> K[å®Œæˆæ‰€æœ‰åˆ†ç‰‡]
    K --> L[æœ€ç»ˆæäº¤DOM]
```

æ¸è¿›å¼æ¸²æŸ“ï¼š

```js
//completeWork (react-reconciler/src/ReactFiberCompleteWork.old.js)
function compeleteWork(current, wrokInProgress, reanderLanes) {
  if (commitCommit > 1000) {
    requestParticalRendering();
  }
}
```

ç”¨æˆ·æ„ŸçŸ¥ï¼š

1. é¦–å±å¿«é€Ÿæ˜¾ç¤º 1000 é¡¹
2. æ»šåŠ¨æ—¶ç»§ç»­æ¸²æŸ“å¯è§åŒºåŸŸ
3. ä¸å¯è§åŒºåŸŸå»¶è¿Ÿæ¸²æŸ“

ä¼˜å…ˆçº§é©±åŠ¨çš„è°ƒåº¦æœºåˆ¶

1. æŒ‰ç´§æ€¥ç¨‹åº¦æ’åºï¼Œé«˜ä¼˜å…ˆæ‰§è¡Œ
2. ä½ä¼˜ï¼ˆå¦‚å¤§é‡æ•°æ®æ¸²æŸ“ï¼‰å¯è¢«ä¸­æ–­ï¼Œå¾…é«˜ä¼˜å…ˆçº§å®Œæˆåæ¢å¤æ‰§è¡Œã€‚
3. è¿™ä¸€æœºåˆ¶ç¡®ä¿ç”¨æˆ·äº¤äº’çš„å³æ—¶å“åº”ï¼ŒåŒæ—¶é¿å…é•¿ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹ã€‚

```js
// scheduler/src/SchedulerPriorities.js
// åœ¨æºç ä¸­ï¼Œä¼˜å…ˆçº§é€šè¿‡ scheduler åŒ…å®šä¹‰çš„ ä¼˜å…ˆçº§å¸¸é‡ åŒºåˆ†ï¼ˆæ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼‰ï¼Œå…³é”®çº§åˆ«å¦‚ä¸‹ï¼š
export const ImmediatePriority = 1; // ç«‹å³æ‰§è¡Œï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œä¸å¯å»¶è¿Ÿï¼‰
export const UserBlockingPriority = 2; // ç”¨æˆ·é˜»å¡çº§ï¼ˆå¦‚è¾“å…¥ã€ç‚¹å‡»ç­‰äº¤äº’ï¼‰
export const NormalPriority = 3; // æ­£å¸¸ä¼˜å…ˆçº§ï¼ˆæ™®é€šæ›´æ–°ï¼‰
export const LowPriority = 4; // ä½ä¼˜å…ˆçº§ï¼ˆå¯å»¶è¿Ÿçš„éç´§æ€¥ä»»åŠ¡ï¼‰
export const IdlePriority = 5; // ç©ºé—²ä¼˜å…ˆçº§ï¼ˆä»…åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œï¼‰
```

```js
// æºç ï¼šscheduleCallback (scheduler/src/Scheduler.js)
function scheduleCallback(priorityLevel, callback) {
  function scheduleCallback(priorityLevel, callback) {
    // è®¡ç®—å½“å‰æ—¶é—´ï¼ˆåŸºäº performance.now()ï¼‰
    const currentTime = getCurrentTime();

    // æ ¹æ®ä¼˜å…ˆçº§è®¡ç®—è¿‡æœŸæ—¶é—´ï¼šé«˜ä¼˜å…ˆçº§ä»»åŠ¡è¿‡æœŸæ—¶é—´æ›´çŸ­ï¼ˆæ›´ç´§æ€¥ï¼‰
    let timeout;
    switch (priorityLevel) {
      case ImmediatePriority:
        timeout = -1; // ç«‹å³è¿‡æœŸï¼ˆå¿…é¡»é©¬ä¸Šæ‰§è¡Œï¼‰
        break;
      case UserBlockingPriority:
        timeout = 250; // 250ms å†…å¿…é¡»æ‰§è¡Œï¼ˆç”¨æˆ·äº¤äº’å®¹å¿çš„æœ€å¤§å»¶è¿Ÿï¼‰
        break;
      case NormalPriority:
        timeout = 5000; // 5ç§’å†…æ‰§è¡Œ
        break;
      case LowPriority:
        timeout = 10000; // 10ç§’å†…æ‰§è¡Œ
        break;
      case IdlePriority:
        timeout = maxSigned31BitInt; // æ— é™æœŸå»¶è¿Ÿï¼ˆä»…ç©ºé—²æ—¶æ‰§è¡Œï¼‰
        break;
    }
    const expirationTime = currentTime + timeout;

    // åˆ›å»ºä»»åŠ¡å¯¹è±¡
    const newTask = {
      callback,
      priorityLevel,
      expirationTime,
      // ...å…¶ä»–å­—æ®µï¼ˆå¦‚æ˜¯å¦å·²å–æ¶ˆã€æ˜¯å¦å·²æ‰§è¡Œç­‰ï¼‰
    };

    // å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—æŒ‰ expirationTime å‡åºæ’åºï¼Œå³ä¼˜å…ˆçº§é«˜çš„åœ¨å‰ï¼‰
    pushTask(newTask);

    // è§¦å‘è°ƒåº¦ï¼ˆè¯·æ±‚ä¸»çº¿ç¨‹ç©ºé—²æ—¶é—´æ‰§è¡Œä»»åŠ¡ï¼‰
    requestHostCallback(workLoop);
    return newTask;
  }
}
```

æ ¸å¿ƒæ¦‚å¿µï¼šæ¸²æŸ“åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ

1. åè°ƒé˜¶æ®µï¼ˆå¯ä¸­æ–­ï¼‰
   - è®¡ç®—è™šæ‹Ÿ Dom diff
   - æ„å»º Filer æ ‘
   - **å¯éšæ—¶ä¸­æ–­**ï¼Œæ— å‰¯ä½œç”¨
2. æäº¤é˜¶æ®µï¼ˆä¸å¯ä¸­æ–­ï¼‰
   - æ›´æ–°çœŸå® DOM
   - æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ
   - åŸå­æ“ä½œã€å¿…é¡»ä¸€æ¬¡æ€§å®Œæˆ
     å¯ä¸­æ–­åŸç†å®ç°

```js
// prepareFreshStack (react-reconciler/src/ReactFiberWorkLoop.old.js)
let wrokInProgress = null;
function prepareFreshStack(root, lanes) {
  // ä¿å­˜å½“å‰å·¥ä½œè¿›åº¦
  workInProgress = createWorkInProgess(root.current, null);
}

function resumeWorkInProgress() {
  // ä»ä¸­æ–­çš„FiberèŠ‚ç‚¹è¿æ¥
  const unitOfWork = workInProgress;
  wrokInProgress = unitOfWork.next;
  return uniOfWork;
}
```

ä¸­æ–­åå‘ç”Ÿä»€ä¹ˆï¼Ÿ

1. ä¿å­˜å½“å‰ Fiber èŠ‚ç‚¹çš„æŒ‡é’ˆ
2. é‡Šæ”¾ä¸»çº¿ç¨‹ç»™æµè§ˆå™¨
3. è®°å½•æœªå®Œæˆçš„ä»»åŠ¡é˜Ÿåˆ—
4. å½“æµè§ˆå™¨ç©ºé—²æ—¶ï¼š

```js
// è°ƒåº¦å™¨å›è°ƒ
requestIdleCallback((deadline) => {
  while (deadline.timeRemaining() > 0 && workInProgress) {
    performUnitOfWork(workInProgress);
  }
});
```

## React 18 æºç ä¸­å¯ä¸­æ–­æ¸²æŸ“çš„å…³é”®å®ç°

ç›¸å…³è§£æï¼š

1. æ—¶é—´åˆ‡ç‰‡å’Œä¸­æ–­åˆ¤æ–­
   - ç”±`scheduler.unstable_shouldYield()`æ£€æŸ¥å½“å‰æ—¶é—´ç‰‡æ˜¯å¦è€—å°½ï¼ˆé»˜è®¤æ¯æ®µå·¥ä½œä¸è¶…è¿‡ 5msï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼‰ã€‚
   - `hasHigherPriorityWork()`æ£€æŸ¥æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥çš„ Immediate ä¼˜å…ˆçº§ï¼‰ï¼Œè‹¥æœ‰åˆ™ç«‹å³ä¸­æ–­ã€‚
2. å·¥ä½œå¾ªç¯`workLoop`
   - ä»¥ while å¾ªç¯é€ä¸ªå¤„ç† currentFiberï¼ˆFiber èŠ‚ç‚¹ï¼‰ï¼Œæ¯æ¬¡å¤„ç†ä¸€ä¸ªå·¥ä½œå•å…ƒï¼ˆperformUnitOfWorkï¼‰ã€‚
   - æ¯æ¬¡å¾ªç¯å‰è°ƒç”¨ shouldYield()ï¼Œè‹¥éœ€è¦ä¸­æ–­åˆ™é€€å‡ºå¾ªç¯ï¼Œä¿å­˜å½“å‰ currentFiber çš„çŠ¶æ€ï¼ˆæœªå®Œæˆçš„å·¥ä½œå•å…ƒï¼‰ã€‚
   - æœªå®Œæˆçš„å·¥ä½œé€šè¿‡ scheduleCallback é‡æ–°è°ƒåº¦ï¼Œåœ¨ä¸‹æ¬¡æ—¶é—´ç‰‡ç»§ç»­æ‰§è¡Œï¼ˆæ¢å¤æ¸²æŸ“ï¼‰ã€‚
3. ä¼˜å…ˆçº§é©±åŠ¨çš„è°ƒåº¦ï¼ˆscheduleUpdateOnFiberï¼‰
   - é«˜ä¼˜å…ˆï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œç›´æ¥åŒæ­¥æ‰§è¡Œï¼ˆworkLoopï¼ˆfalseï¼‰ï¼‰ï¼Œä¸å…è®¸ä¸­æ–­ï¼Œç¡®ä¿å“åº”åŠæ—¶ã€‚
   - æ™®é€šä¼˜å…ˆçº§è°ƒåº¦ï¼ˆå¦‚åˆ—è¡¨æ¸²æŸ“ï¼‰å¼‚æ­¥è°ƒåº¦ï¼Œå…è®¸è¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­ï¼Œå¹³è¡¡æ€§èƒ½ä¸ç”¨æˆ·ä½“éªŒã€‚

```js
// 1. è°ƒåº¦ä¼˜å…ˆçº§ç›¸å…³å¸¸é‡ï¼ˆç®€åŒ–ï¼‰
const PriorityLevel = {
  Immediate: 1, // åŒæ­¥ä¼˜å…ˆçº§ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰
  UserBlocking: 2, // ç”¨æˆ·é˜»å¡çº§ï¼ˆå¦‚ç‚¹å‡»äº‹ä»¶ï¼‰
  Normal: 3, // æ™®é€šä¼˜å…ˆçº§ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚åçš„æ›´æ–°ï¼‰
  Low: 4, // ä½ä¼˜å…ˆçº§ï¼ˆå¦‚åå°è®¡ç®—ï¼‰
  Idle: 5, // ç©ºé—²æ—¶æ‰§è¡Œï¼ˆå¦‚æ—¥å¿—æ”¶é›†ï¼‰
};

// 2. åˆ¤æ–­æ˜¯å¦éœ€è¦è®©å‡ºä¸»çº¿ç¨‹ï¼ˆæ ¸å¿ƒï¼šæ—¶é—´åˆ‡ç‰‡æ£€æŸ¥ï¼‰
function shouldYield() {
  // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦è¶…è¿‡åˆ†é…çš„æ—¶é—´ç‰‡ï¼ˆé€šå¸¸ä¸º5msï¼‰
  // æˆ–å­˜åœ¨æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡
  return (
    scheduler.unstable_shouldYield() || // æ¥è‡ªscheduleråŒ…çš„æ—¶é—´ç‰‡æ£€æŸ¥
    hasHigherPriorityWork() // æ£€æŸ¥æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡
  );
}

// 3. å·¥ä½œå¾ªç¯ï¼šå¤„ç†FiberèŠ‚ç‚¹ï¼Œæ”¯æŒä¸­æ–­ä¸æ¢å¤
function workLoop(hasTimeRemaining, initialLane) {
  let currentFiber = workInProgress; // å½“å‰æ­£åœ¨å¤„ç†çš„FiberèŠ‚ç‚¹

  while (currentFiber !== null && !shouldYield()) {
    // å¤„ç†å½“å‰FiberèŠ‚ç‚¹ï¼ˆæ‰§è¡ŒbeginWorkï¼Œè®¡ç®—å·®å¼‚ï¼‰
    currentFiber = performUnitOfWork(currentFiber);
  }

  // å¦‚æœå·¥ä½œæœªå®Œæˆï¼ˆcurrentFiberä¸ä¸ºnullï¼‰ï¼Œåˆ™éœ€è¦å†æ¬¡è°ƒåº¦
  if (currentFiber !== null) {
    // å®‰æ’ä¸‹ä¸€æ¬¡æ—¶é—´ç‰‡ç»§ç»­å¤„ç†
    scheduleCallback(NormalPriority, () => {
      workLoop(true, initialLane);
    });
  } else {
    // æ‰€æœ‰å·¥ä½œå•å…ƒå¤„ç†å®Œæˆï¼Œè¿›å…¥Commité˜¶æ®µ
    commitRoot(root);
  }
}

// 4. æ‰§è¡Œå•ä¸ªå·¥ä½œå•å…ƒï¼ˆå¤„ç†ä¸€ä¸ªFiberèŠ‚ç‚¹ï¼‰
function performUnitOfWork(fiber) {
  // 1. å¤„ç†å½“å‰FiberèŠ‚ç‚¹ï¼ˆå¦‚è®¡ç®—æ–°çš„propsã€åˆ›å»ºå­èŠ‚ç‚¹ï¼‰
  const next = beginWork(fiber, root);

  // 2. å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œå°è¯•å¤„ç†å…„å¼ŸèŠ‚ç‚¹
  if (next === null) {
    return completeUnitOfWork(fiber);
  } else {
    // æœ‰å­èŠ‚ç‚¹ï¼Œä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒä¸ºå­èŠ‚ç‚¹
    return next;
  }
}

// 5. å¯åŠ¨æ¸²æŸ“ï¼ˆè°ƒåº¦å…¥å£ï¼‰
function scheduleUpdateOnFiber(fiber, lane) {
  // æ ¹æ®ä¼˜å…ˆçº§è°ƒåº¦å·¥ä½œå¾ªç¯
  if (lane === ImmediatePriority) {
    // é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼šåŒæ­¥æ‰§è¡Œå·¥ä½œå¾ªç¯ï¼ˆä¸ä¸­æ–­ï¼‰
    workLoop(false, lane);
  } else {
    // æ™®é€šä¼˜å…ˆçº§ï¼šå¼‚æ­¥è°ƒåº¦ï¼Œå…è®¸ä¸­æ–­
    scheduleCallback(laneToPriority(lane), () => {
      workLoop(true, lane);
    });
  }
}
```

## 2.è§£é‡Šè™šæ‹Ÿ DOM çš„å·¥ä½œåŸç†ä»¥åŠå…¶æ€§èƒ½ä¼˜åŒ–çš„æœºåˆ¶ï¼Ÿ

1. åŸç†ï¼šå°† jsx ç¼–è¯‘ä¸ºä¸€ä¸ª render å‡½æ•°ï¼Œæ‰§è¡Œ render å‡½æ•°ä¼šç”Ÿæˆä¸€ä¸ª React Element çš„ js å¯¹è±¡ï¼ˆä¹Ÿç§°ä¸ºè™šæ‹Ÿ domï¼‰
   æ€§èƒ½ä¼˜åŒ–çš„æœºåˆ¶ï¼šåœ¨çŠ¶æ€å‘ç”Ÿæ›´æ–°çš„æ—¶å€™ï¼Œä¼šæ ¹æ®å‰å vdom è¿›è¡Œå¯¹æ¯”ï¼Œæ ‡è®°å¢åˆ æ”¹çš„ç»„ä»¶çŠ¶æ€ï¼Œè§£æå®Œæ•´æ ‘ååœ¨å¯¹åº”çœŸå® DOM çš„å¢åˆ æ”¹æ›´æ–°ã€‚

2. è™šæ‹Ÿ DOM çš„æ¦‚å¿µï¼šè™šæ‹Ÿ DOM æ˜¯ä¸€ç§åœ¨å†…å­˜è¡¨ç¤ºçœŸå® DOM çš„è½»é‡çº§å‰¯æœ¬çš„æŠ€æœ¯ã€‚å®ƒæ˜¯ä¸€ä¸ª javascript å¯¹è±¡ï¼Œæ¨¡æ‹Ÿäº†æµè§ˆå™¨çš„ DOM ç»“æ„ã€‚
   å·¥ä½œåŸç†ï¼šåˆæ¬¡æ¸²æŸ“ï¼šå½“ React åº”ç”¨é¦–æ¬¡åŠ è½½ï¼Œå®ƒä¼šæ„å»ºä¸€ä¸ªè™šæ‹Ÿ DOMï¼Œæ˜¯ React å…ƒç´ çš„ javascript å¯¹è±¡è¡¨ç¤ºã€‚è¿™ä¸ªè™šæ‹Ÿ DOM æ ‘åŒ…å«äº†æ‰€æœ‰çš„ UI ç»„ä»¶ä»¥åŠå®ƒä»¬çš„çŠ¶æ€ï¼›æ›´æ–°ç»„ä»¶çŠ¶æ€ï¼šå½“ç»„ä»¶çš„ state æˆ–è€… props å‘ç”Ÿå˜åŒ–ï¼ŒReact ä¼šé‡æ–°æ¸²æŸ“è¯¥ç»„ä»¶ã€‚æ­¤æ—¶ React ä¼šæ„å»ºæ–°çš„è™šæ‹Ÿ DOM æ ‘ï¼Œå¹¶ä¸ä¸Šä¸€æ¬¡æ¸²æŸ“çš„è™šæ‹Ÿ DOM æ ‘è¿›è¡Œå¯¹æ¯”ã€‚æ‰¹é‡æ›´æ–°ï¼šä¸€æ—¦ç¡®è®¤æŸéƒ¨åˆ†éœ€è¦æ›´æ–°ï¼ŒReact ä¼šå°†è¿™äº›æ›´æ–°æ‰¹é‡æäº¤ç»™çœŸå® DOMã€‚
   æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼š
   Diff ç®—æ³•æ˜¯ React æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒã€‚

- åŸºäºç»„ä»¶å±‚çº§çš„æ¯”è¾ƒï¼šå®ƒå‡å®šåŒä¸€å±‚çº§çš„å…ƒç´ å¤§æ¦‚ç‡ä¸å˜ï¼Œå› æ­¤ React å¯ä»¥è·³è¿‡å¯¹å…ƒç´ ç±»å‹çš„æ·±åº¦æ¯”è¾ƒï¼Œä¼˜å…ˆå¯¹èŠ‚ç‚¹çš„å…³é”®å±æ€§è¿›è¡Œæ¯”è¾ƒã€‚
- æœ€å°åŒ–æ¯”è¾ƒèŒƒå›´ï¼šReact ä¸ä¼šå¯¹æ•´ä½“è™šæ‹Ÿ Dom æ ‘è¿›è¡Œå®Œå…¨å¯¹æ¯”ï¼Œè€Œæ˜¯åªæ¯”è¾ƒæœ€è¿‘å‘ç”Ÿæ”¹å˜çš„éƒ¨åˆ†ã€‚
- å‡è®¾åŒç±»å…ƒç´ ç›¸åŒï¼šReact å‡è®¾åŒä¸€ç±»å‹çš„ DOM å…ƒç´ åœ¨æ›´æ–°æ—¶ä¸å‘ç”Ÿé‡å¤§ç»“æ„å˜åŒ–ï¼Œå› æ­¤å®ƒä¼šé‡ç”¨ä¹‹å‰çš„ Dom èŠ‚ç‚¹ã€‚è¿™ç§ä¼˜åŒ–ç­–ç•¥å«åšâ€œå…ƒç´ ç±»å‹çš„é‡ç”¨â€ï¼Œå®ƒé¿å…äº†ä¸å¿…è¦çš„ Dom å…ƒç´ é‡å»ºã€‚
  æœ€å°åŒ–çœŸå® DOM çš„æ“ä½œ
- æ‰¹é‡æ›´æ–°ï¼šReact ä¼šå°†å¤šæ¬¡éœ€è¦æ›´æ–° DOM çš„æ“ä½œåˆå¹¶æˆä¸€ä¸ªæ‰¹é‡æ›´æ–°çš„è¿‡ç¨‹ï¼Œå‡å°‘äº†æ¯æ¬¡æ›´æ–°çš„å¼€é”€ã€‚
- é€‰æ‹©æ€§æ›´æ–°ï¼šåªæ›´æ–°å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ† DOM å…ƒç´ ã€‚
- å±€éƒ¨æ›´æ–°ï¼šåˆ©ç”¨è™šæ‹Ÿ DOM çš„ diffï¼Œåªæ›´æ–°å®é™…å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†ï¼Œè€Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªé¡µé¢æˆ–ç»„ä»¶ã€‚
  reconcilation çš„è¿‡ç¨‹
  reconcilation æ˜¯æŒ‡ React å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªè™šæ‹Ÿ DOM æ ‘å¹¶å†³å®šå¦‚ä½•å°†å®ƒä»¬æ›´æ–°åˆ°çœŸå® DOM ä¸­ã€‚Reconciliation ä¹ŸåŒ…å«æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼š
- ç»„ä»¶ key å±æ€§ï¼šç”¨äºå¸®åŠ©è¯†åˆ«é‚£äº›å…ƒç´ è¢«æ›´æ”¹ã€æ·»åŠ æˆ–è€…åˆ é™¤ã€‚
- å…ƒç´ ç±»å‹æ¯”è¾ƒï¼šReact å‡è®¾å¦‚æœä¸¤ä¸ªç›¸åŒå±‚çº§çš„ DOM å…ƒç´ ç±»å‹å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå®ƒä»¬çš„ç»“æ„å¾ˆå¯èƒ½ä¼šä¸åŒï¼Œå› æ­¤å®ƒä¼šé€‰æ‹©é‡æ–°åˆ›å»ºæ•´ä¸ª DOM å…ƒç´ ã€‚

é€šè¿‡ä¸€äº›ç­–ç•¥ä¼˜åŒ–æ€§èƒ½ï¼š

- shouldComponentUpdate è¿”å› true æ‰é‡æ–°æ¸²æŸ“è¯¥ç»„ä»¶
- React.memoã€‚å¯¹äºå‡½æ•°ç»„ä»¶ï¼Œå¦‚æœ props ä¸å˜åŒ–ï¼Œåˆ™è·³è¿‡æ¸²æŸ“è¿‡ç¨‹ï¼Œç›´æ¥å¤ç”¨ä¹‹å‰çš„ç»“æœã€‚
- æ‡’åŠ è½½å’Œä»£ç åˆ†å‰²ã€‚react é€šè¿‡ React.lazy å’Œ Suspense å®ç°ç»„ä»¶æ‡’åŠ è½½ã€‚

## 12.è™šæ‹Ÿ DOM çš„ diff ä¸åŸç†ï¼ˆå¦‚å±‚çº§æ¯”è¾ƒã€key å€¼ä½œç”¨ï¼‰

diff çš„åŸºæœ¬åŸç†

1. åŒä¸€å±‚çº§æ¯”è¾ƒ
   - React è®¤ä¸º Dom æ ‘ä¸­æ¯å±‚çš„èŠ‚ç‚¹éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå±‚çº§æ¯”è¾ƒå³åœ¨ç»Ÿä¸€å±‚çº§ä¸Šè¿›è¡ŒèŠ‚ç‚¹çš„é€ä¸ªæ¯”è¾ƒã€‚å¦‚æœèŠ‚ç‚¹ç±»å‹ç›¸åŒï¼Œåˆ™æ›´æ–°æ”¹èŠ‚ç‚¹ï¼›å¦‚æœç±»å‹ä¸åŒï¼Œåˆ™åˆ é™¤æ—§èŠ‚ç‚¹ï¼Œæ’å…¥æ–°èŠ‚ç‚¹ã€‚
2. é€’å½’æ¯”è¾ƒå­æ ‘
   - å¦‚æœä¸¤æ ‘ç±»å‹ç›¸åŒï¼ŒReact ä¼šç»§ç»­é€’å½’æ¯”è¾ƒå®ƒä»¬çš„å­èŠ‚ç‚¹ï¼Œæ›´æ–°æˆ–è€…åˆ é™¤å­èŠ‚ç‚¹ã€‚å¦åˆ™ï¼Œä¼šè·³è¿‡è¯¥æ ‘æ¯”è¾ƒï¼Œç›´æ¥é”€æ¯å¹¶æ›¿æ¢æ‰æ—§çš„å­æ ‘ã€‚
3. é€ä¸ªæ¯”è¾ƒèŠ‚ç‚¹çš„å±æ€§
   - åœ¨æ›´æ–°èŠ‚ç‚¹æ—¶ï¼Œä¼šé€šè¿‡æ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹çš„å±æ€§ï¼ˆclassnameã€styleã€children ç­‰ï¼‰ï¼Œæ›´æ–°èŠ‚ç‚¹çš„å±æ€§ã€‚å¦‚æœå±æ€§å‘ç”Ÿå˜åŒ–ï¼ŒReact ä¼šæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯é‡æ–°æ¸²æŸ“æ•´ä¸ªèŠ‚ç‚¹ã€‚
4. å¯¹æ¯”å…ƒç´ ç±»å‹
   - å¦‚æœèŠ‚ç‚¹ç±»å‹ï¼ˆæ¯”å¦‚`<div> <span>`ä¸åŒï¼ŒReact ä¼šé”€æ¯æ—§èŠ‚ç‚¹ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒReact ä¿è¯ä¸ä¼šé”™è¯¯åœ°å¤ç”¨ä¸ç›¸å¹²çš„ç»„ä»¶ã€‚

å±‚çº§æ¯”è¾ƒå’Œ key çš„ä½œç”¨

- åŒçº§æ¯”è¾ƒå¯ä»¥å¤§å¤§å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“
- key è·Ÿè¸ªæ¯ä¸ªå…ƒç´ çš„èº«ä»½ï¼Œé¿å…é”™è¯¯åœ°å¤ç”¨å…ƒç´ ã€‚æé«˜æ¯”è¾ƒæ•ˆç‡ã€‚é¿å…ä¸å¿…è¦çš„ç»„ä»¶çš„æ¸²æŸ“ã€‚æé«˜æ€§èƒ½ã€‚

react å¯¹ diff ç®—æ³•çš„ä¼˜åŒ–

1. å…ƒç´ çš„æ’åºï¼šé¿å…å¯¹æ‰€æœ‰èŠ‚ç‚¹çš„å¯¹æ¯”ï¼Œåªå¯¹ç›¸åŒç±»å‹çš„èŠ‚ç‚¹è¿›è¡Œæ·±åº¦æ¯”è¾ƒï¼Œè·³è¿‡ä¸ç›¸å…³çš„éƒ¨åˆ†ã€‚
2. åŒå±‚æ¯”è¾ƒã€‚å‡è®¾ä¸åŒå±‚çº§èŠ‚ç‚¹é€šå¸¸ä¸å‘ç”Ÿå˜åŒ–ã€‚å› æ­¤å®ƒåªä¼šåœ¨åŒä¸€å±‚çº§å†…æ¯”è¾ƒèŠ‚ç‚¹ã€‚ä¸åŒå±‚çº§èŠ‚ç‚¹ç›´æ¥é”€æ¯é‡å»ºã€‚
3. ç»„ä»¶çš„å¤ç”¨ï¼Œé€šè¿‡ Key ä¿è¯åˆ—è¡¨å…ƒç´ çš„å¤ç”¨ï¼Œå‡å°‘åˆ—è¡¨æ¸²æŸ“æ—¶çš„æ€§èƒ½å¼€é”€ã€‚
4. æœ€å°åŒ–æ›´æ–°ï¼šé€šè¿‡ç²¾ç¡®çš„å·®å¼‚è®¡ç®—ï¼ŒReact èƒ½å¤Ÿåœ¨æœ€å°åŒ–æ›´æ–°çš„åŒæ—¶ä¿è¯é¡µé¢çš„ä¸€è‡´æ€§å’Œæ€§èƒ½ã€‚åªä¼šå‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†è¿›è¡Œæ›´æ–°ï¼Œä»è€Œé¿å…å¤§é‡çš„é‡å¤æ“ä½œã€‚

```mermaid
graph LR
A[æ–°æ—§è™šæ‹ŸDOMæ ‘] --> B[Diffç®—æ³•]
B --> C[æ‰¾å‡ºæœ€å°å˜æ›´é›†]
C --> D[é«˜æ•ˆæ›´æ–°çœŸå®DOM]
```

æºç å¯¼è¯»
è·¯å¾„:`packages/react-reconciler/src/ReactFiberBeginWork.old.js`

| å‚æ•°           | å…³é”®ä½œç”¨            | å½±å“ diff è¡Œä¸º       |
| -------------- | ------------------- | -------------------- |
| current        | æä¾›æ—§ Fiber æ ‘ç»“æ„ | å†³å®šå¤ç”¨å¯èƒ½æ€§       |
| workInProgress | æ‰¿è½½æ–° Fiber æ„å»º   | Diff ç»“æœå®¹å™¨        |
| nextChildren   | æä¾›æ–°è™šæ‹Ÿ Dom ç»“æ„ | Diff çš„ç›®æ ‡          |
| renderLanes    | ç¡®å®šæ¸²æŸ“ä¼˜å…ˆçº§      | æ§åˆ¶ diff æ·±åº¦å’ŒèŒƒå›´ |

```js
function reconcileChildren(
  current: Fiber | null,
  workInProgress: Fiber,
  nextChildren: any,
  renderLanes: Lanes
) {
  if (current === null) {
    // æŒ‚è½½é˜¶æ®µ
    workInProgress.child = mountChildFibers(
      workInProgress,
      null,
      nextChildren,
      renderLanes
    );
  } else {
    // æ›´æ–°é˜¶æ®µï¼ˆDiffæ ¸å¿ƒï¼‰
    workInProgress.child = reconcileChildFibers(
      workInProgress,
      current.child,
      nextChildren,
      renderLanes
    );
  }
}
```

### ğŸ”¥ ä¸‰å¤§ç­–ç•¥

1ï¸âƒ£ åŒçº§æ¯”è¾ƒç­–ç•¥

```js
function reconcileChildFibers(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  newChild: any,
  lanes: Lanes
): Fiber | null {
  // ç­–ç•¥1ï¼šå•èŠ‚ç‚¹Diff
  if (typeof newChild === "object" && newChild !== null) {
    switch (newChild.$$typeof) {
      case REACT_ELEMENT_TYPE:
        return placeSingleChild(
          reconcileSingleElement(
            returnFiber,
            currentFirstChild,
            newChild,
            lanes
          )
        );
    }
  }

  // ç­–ç•¥2ï¼šå¤šèŠ‚ç‚¹Diff
  if (isArray(newChild)) {
    return reconcileChildrenArray(
      returnFiber,
      currentFirstChild,
      newChild,
      lanes
    );
  }

  // ...å…¶ä»–ç±»å‹å¤„ç†
}
```

2ï¸âƒ£ ç»„ä»¶ç±»å‹åˆ¤æ–­

```js
function reconcileSingleElement(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  element: ReactElement,
  lanes: Lanes
): Fiber {
  const key = element.key;
  let child = currentFirstChild;

  // éå†æ—§å­èŠ‚ç‚¹
  while (child !== null) {
    if (child.key === key) {
      // KEYç›¸åŒ
      if (child.elementType === element.type) {
        // ç±»å‹ç›¸åŒ â†’ å¤ç”¨èŠ‚ç‚¹
        deleteRemainingChildren(returnFiber, child.sibling);
        const existing = useFiber(child, element.props);
        existing.ref = coerceRef(returnFiber, child, element);
        existing.return = returnFiber;
        return existing;
      } else {
        // ç±»å‹ä¸åŒ â†’ åˆ é™¤æ—§èŠ‚ç‚¹
        deleteRemainingChildren(returnFiber, child);
        break;
      }
    } else {
      // KEYä¸åŒ â†’ åˆ é™¤æ—§èŠ‚ç‚¹
      deleteChild(returnFiber, child);
    }
    child = child.sibling;
  }

  // åˆ›å»ºæ–°èŠ‚ç‚¹
  const created = createFiberFromElement(element, returnFiber.mode, lanes);
  created.ref = coerceRef(returnFiber, currentFirstChild, element);
  created.return = returnFiber;
  return created;
}
```

3ï¸âƒ£ Key ä¼˜åŒ–ç­–ç•¥

```js
function reconcileChildrenArray(
  returnFiber: Fiber,
  currentFirstChild: Fiber | null,
  newChildren: Array<*>,
  lanes: Lanes
): Fiber | null {
  // ç”Ÿæˆæ—§èŠ‚ç‚¹Map {key: Fiber}
  const existingChildren = mapRemainingChildren(returnFiber, currentFirstChild);

  for (; newIdx < newChildren.length; newIdx++) {
    const newFiber = updateFromMap(
      existingChildren,
      returnFiber,
      newIdx,
      newChildren[newIdx],
      lanes
    );

    if (newFiber !== null) {
      if (shouldTrackSideEffects) {
        if (newFiber.alternate !== null) {
          // èŠ‚ç‚¹å¤ç”¨ â†’ ä»Mapä¸­åˆ é™¤
          existingChildren.delete(
            newFiber.key === null ? newIdx : newFiber.key
          );
        }
      }

      // æ£€æŸ¥èŠ‚ç‚¹ç§»åŠ¨
      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);
    }
  }

  // åˆ é™¤æœªä½¿ç”¨çš„æ—§èŠ‚ç‚¹
  existingChildren.forEach((child) => deleteChild(returnFiber, child));
}
```

Diff æ ¸å¿ƒç®—æ³•ï¼š`placeChild`

```js
function placeChild(
  newFiber: Fiber,
  lastPlacedIndex: number,
  newIndex: number
): number {
  newFiber.index = newIndex;

  const current = newFiber.alternate;
  if (current !== null) {
    const oldIndex = current.index;
    if (oldIndex < lastPlacedIndex) {
      // ç§»åŠ¨èŠ‚ç‚¹ â†’ æ·»åŠ  Placement flag
      newFiber.flags |= Placement;
      return lastPlacedIndex;
    } else {
      // ä½ç½®ä¸å˜
      return oldIndex;
    }
  } else {
    // æ–°å¢èŠ‚ç‚¹ â†’ æ·»åŠ  Placement flag
    newFiber.flags |= Placement;
    return lastPlacedIndex;
  }
}
```

ğŸ”„ Diff å…¨æµç¨‹

```mermaid
sequenceDiagram
    participant Scheduler
    participant Reconciler
    participant DiffAlgo
    participant FiberTree

    Scheduler->>Reconciler: å¼€å§‹æ¸²æŸ“ï¼ˆrenderLanesï¼‰
    Reconciler->>DiffAlgo: reconcileChildFibers()

    loop èŠ‚ç‚¹Diff
        DiffAlgo->>DiffAlgo: æ¯”è¾ƒèŠ‚ç‚¹key/type
        alt èŠ‚ç‚¹å¯å¤ç”¨
            DiffAlgo->>FiberTree: å¤ç”¨FiberèŠ‚ç‚¹
        else èŠ‚ç‚¹éœ€æ›´æ–°
            DiffAlgo->>FiberTree: æ ‡è®°æ›´æ–°(flags)
        else èŠ‚ç‚¹éœ€ç§»åŠ¨
            DiffAlgo->>FiberTree: æ ‡è®°ç§»åŠ¨(Placement)
        else èŠ‚ç‚¹éœ€åˆ é™¤
            DiffAlgo->>FiberTree: æ ‡è®°åˆ é™¤(Deletion)
        end
    end

    Reconciler->>Scheduler: å®ŒæˆDiffï¼ˆeffectListï¼‰
```

ğŸ’¡ Diff ç»“æœæäº¤

```js
function commitMutationEffects(
  root: FiberRoot,
  firstChild: Fiber,
  committedLanes: Lanes
) {
  let fiber = firstChild;
  while (fiber !== null) {
    // å¤„ç†æ’å…¥/ç§»åŠ¨
    if (fiber.flags & Placement) {
      commitPlacement(fiber);
    }
    // å¤„ç†åˆ é™¤
    if (fiber.flags & Deletion) {
      commitDeletion(root, fiber);
    }
    // å¤„ç†æ›´æ–°
    if (fiber.flags & Update) {
      commitWork(fiber);
    }
    fiber = fiber.sibling;
  }
}
```

### æ€»ç»“ React18 çš„ diff åŸç†

1.åŒæŒ‡é’ˆéå†

- æ–°æ—§åŒæ—¶éå†
- é€šè¿‡ oldIndex å’Œ newIndex åˆ¤æ–­ç§»åŠ¨

```js
// åœºæ™¯1:ä¸¾ä¾‹ åˆ—è¡¨å¤´éƒ¨æ’å…¥
// æ—§ Bã€C
// æ–° Aã€Bã€C
1. Bï¼ˆæ—§ï¼‰ VS Aï¼ˆæ–°ï¼‰ ä¸­æ–­
2.map ä¿å­˜æ—§ï¼Œ éå†æ–°èŠ‚ç‚¹ï¼Œå¤ç”¨ Bã€C
3.åˆ›å»ºA -> æ ‡è®°Placement(æ’å…¥å¤´éƒ¨)
```

```js
//åœºæ™¯2
// æ—§: [A, B, C, D]
// æ–°: [A, C, D]

1. A å¤ç”¨
2.B(æ—§) vs C(æ–°) keyä¸åŒï¼Œä¸­æ–­
3.æ”¶é›†æ—§ï¼Œéå†æ–°ï¼Œå¤ç”¨Cã€D
4.åˆ é™¤B
```

å…³é”®è®¾è®¡æ€æƒ³

1.ç§»åŠ¨ä¼˜åŒ–åˆ é™¤é‡å»º;ä½ç½®ç´¢å¼•è¿½è¸ªï¼›æ‰¹å¤„ç†ç§»åŠ¨æ“ä½œ`commitPlacement`

2.ä¸‰å±‚ä¼˜åŒ–ç­–ç•¥

- åŒçº§æ¯”è¾ƒ
- ç±»å‹æ¯”è¾ƒ
- key ä¼˜åŒ–

  3.Fiber é“¾è¡¨ç»“æ„

- é€šè¿‡ childrenã€siblingã€return å…³è”
- å¢é‡ diffï¼ˆå¯ä¸­æ–­å›å¤ï¼‰ ï¼Ÿï¼Ÿ

  4.Lane ä¼˜å…ˆçº§ ï¼ˆä¹Ÿä¼šå½±å“ diff çš„èŒƒå›´å’Œæ·±åº¦ï¼‰ ï¼Ÿï¼Ÿ

- é«˜ä¼˜æ›´æ–°ä¼˜å…ˆ Diff ï¼Ÿï¼Ÿ
- ä½ä¼˜æ›´æ–°å¯è¢«å¤§æ–­ ï¼Ÿï¼Ÿ

  5.Effect æ ‡è®°

- æœ€å°åŒ– Dom æ“ä½œ
- æ‰¹é‡æ‰§è¡Œå˜æ›´
