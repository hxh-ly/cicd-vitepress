# 浏览器原理

## http强缓存和协商缓存
1. 什么是http缓存？作用是什么？
是浏览器为了减少网络请求，提升页面加载速度而对服务器响应资源进行本地存储的机制。

2. 强缓存和协商缓存的核心区别
- 强缓存，从本地读取缓存，不再向服务端发起请求
- 协商缓存，从本地读取缓存，如果缓存过期需要向服务器发起请求，服务端判断请求是否可用。
  - 若未更新，返回 304 `Not Modified` 客户端使用本地缓存。
  - 若更新，返回 200 并更新缓存。
3. 实现机制
强缓存
- `expires http 1.0`和`Cache Concrol http1.1`
- expires
- - 格式 `Expires:Wed,21 Oct 2025 07:28:00 GMT`（服务器的绝对时间）
- - 问题依赖客户端和服务器时间同步

- cache-control
-  格式 `Cache-Control:max-age=5000`(相对于服务器请求时间)
-  常用指令
- - `max-age=xxx`:资源有效期
- - `public`:允许任何缓存（如cdn、代理服务器）存储该资源
- - `private`:允许客户端（浏览器）缓存
- - `no-cache`:不使用强缓存，必需走协商缓存
- - `no-store`:完全不走缓存

协商缓存
- 第一组 `Last-Modified` + `If-Modified-Since`
  - 响应头 `Last-Modifed`：服务器返回资源最后修改时间
  - 请求头 `If-Modified-Since`:客户端再次发起请求时，携带上次`Last-Modifed`值，服务端对比：
  - - 若资源最后修改时间<=该值，未更新，返回 `304`
  - - 若更新，返回200+新资源 同时更新`Last-Modifed`
- 第二组 `ETag` + `Last-Modified`
- 响应头 `ETag`：生成一个唯一标示符
- 请求头 `If-None-Match`:客户端再次发起请求时，携带上次`ETag`值，服务器对比：
- - 若`ETag`不一致，表示更新 返回 200 + 新内容 + 新`ETag`。
- - 如一致 返回 304 表示资源未更新

### `ETag`比`Last-Modifed`更优，为什么
- `Last-Modifed`只能精确修改，同一秒多次修改，无法识别
- 若资源内容没变只修改名字，`Last-Modifed`标记为更新
- ETag基于资源内容生成

### 流程与优先级
1.客户端请求资源时，先检查强缓存
- 若 Cache-Control/Expires 未过期，直接使用本地缓存（强缓存命中）；
- 若已过期，进入下一步。
2.强缓存未命中时，触发协商缓存：
- 客户端发送请求，携带 If-Modified-Since/If-None-Match 到服务器；
- 服务器验证资源是否更新：
- - 未更新：返回 304，客户端使用本地缓存（协商缓存命中）；
- - 已更新：返回 200 和新资源，客户端更新本地缓存。

### 如何判断命中强还是协商
- 强缓存命中：网络面板中状态码可能显示 200 OK (from cache) 或不显示状态码（直接从内存 / 磁盘缓存读取），且无请求发送到服务器。
- 协商缓存命中：状态码显示 304 Not Modified，有请求发送到服务器，但服务器未返回资源内容。
- 未命中缓存：状态码显示 200 OK，服务器返回完整资源。

![alt text](image.png)

## 浏览器渲染原理